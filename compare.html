<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MV – Jämför målvakter</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}</style>
  <link rel="manifest" href="manifest.webmanifest">
</head>
<body class="bg-gray-50">
  <div class="mx-auto max-w-screen-lg p-3 sm:p-4">
    <!-- Header -->
    <div class="sticky top-0 z-10 -mx-3 -mt-3 mb-3 bg-white/80 backdrop-blur p-3 border-b">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-xl font-bold">MV – Jämför målvakter</h1>
          <p class="text-sm text-gray-600">Välj flera i samma team och jämför</p>
        </div>
        <a href="index.html" class="text-sm underline">← Tillbaka</a>
      </div>
    </div>

    <!-- Val -->
    <div class="rounded-2xl border bg-white p-4 shadow-sm mb-4">
      <div class="grid gap-3 sm:grid-cols-3">
        <div>
          <div class="text-xs text-gray-500 mb-1">Team-ID (från URL)</div>
          <input id="team-id" class="w-full rounded-xl border p-2 text-sm" disabled>
        </div>
        <div class="sm:col-span-2">
          <div class="text-xs text-gray-500 mb-1">Välj målvakter (2–4)</div>
          <select id="sel-goalies" class="w-full rounded-xl border p-2 text-sm" multiple size="6"></select>
          <div class="mt-2 flex gap-2">
            <button id="btn-compare" class="rounded-xl border px-3 py-1 text-sm">Jämför</button>
            <button id="btn-export" class="rounded-xl border px-3 py-1 text-sm" disabled>Exportera CSV</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Totals -->
    <div id="totals" class="grid gap-3 sm:grid-cols-2 lg:grid-cols-4 mb-4"></div>

    <!-- Grafer -->
    <div class="grid gap-4 mb-4">
      <div class="rounded-2xl border shadow-sm p-3 bg-white">
        <div class="text-sm text-gray-500">Rädd% över tid (overlay)</div>
        <div class="mt-3 h-56"><canvas id="svpctChart"></canvas></div>
        <div id="empty-svpct" class="text-center text-sm text-gray-500 mt-2 hidden">Ingen data att visa.</div>
      </div>
      <div class="rounded-2xl border shadow-sm p-3 bg-white">
        <div class="text-sm text-gray-500">Skott & Räddningar per match (summa per datum)</div>
        <div class="mt-3 h-56"><canvas id="srChart"></canvas></div>
        <div id="empty-sr" class="text-center text-sm text-gray-500 mt-2 hidden">Ingen data att visa.</div>
      </div>
    </div>

    <div id="msg" class="text-sm text-red-600"></div>
  </div>

<script>
/* ===== URL & Supabase (samma som index.html) ===== */
const qs = new URLSearchParams(location.search);
const TEAM_ID = qs.get('team') || '';    // compare.html?team=<TEAM_ID>
const SUPABASE_URL  = "https://okdvcvbmgposbhvrygop.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rZHZjdmJtZ3Bvc2JodnJ5Z29wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2ODgyMjUsImV4cCI6MjA3MzI2NDIyNX0.w4SCljFULEduafWZexzmQqyG08pGoUFOeSCbfuCFaJg";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
  auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true, storage:window.localStorage }
});

/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const pct = (saves, shots)=> shots>0 ? ((saves/shots)*100).toFixed(2)+'%' : '–';
const pctNum = (saves, shots)=> shots>0 ? +(((saves/shots)*100).toFixed(2)) : null;
const escCSV = v => { const s=String(v??''); return /[;"\n]/.test(s)?'"'+s.replaceAll('"','""')+'"':s; };
function download(filename, content, mime){ const b=new Blob([content],{type:(mime||'text/plain')+';charset=utf-8'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=filename; a.click(); URL.revokeObjectURL(u); }
const palette = i => ['rgba(33,150,243,1)','rgba(76,175,80,1)','rgba(255,152,0,1)','rgba(244,67,54,1)'][i%4];

/* ===== Session ===== */
async function ensureSession(timeoutMs=4000){
  let s = (await sb.auth.getSession()).data.session;
  if (s) return s;
  return new Promise(resolve=>{
    const t=setTimeout(async()=>resolve((await sb.auth.getSession()).data.session||null),timeoutMs);
    const { data:sub } = sb.auth.onAuthStateChange((_e, sess)=>{ if(sess){clearTimeout(t); sub.subscription.unsubscribe(); resolve(sess);} });
  });
}

/* ===== Laddning av målvakter ===== */
let ALL_GOALIES = [];
async function loadGoalies(){
  const r = await sb.from('goalies').select('id,code,name').eq('team_id', TEAM_ID).order('code');
  if(r.error) throw r.error;
  ALL_GOALIES = r.data || [];
  const sel = $('#sel-goalies'); sel.innerHTML='';
  ALL_GOALIES.forEach(g=>{
    const opt=document.createElement('option');
    opt.value=g.id; opt.textContent=`${g.name} (${g.code})`;
    sel.appendChild(opt);
  });
}

/* ===== Hämta data för valda ===== */
async function fetchDataFor(goalieIds){
  const st = await sb.from('match_goalie_stats')
    .select('match_id, goalie_id, minutes, saves, shots')
    .eq('team_id', TEAM_ID)
    .in('goalie_id', goalieIds);
  if(st.error) throw st.error;

  const matchIds=[...new Set(st.data.map(x=>x.match_id))];
  if(!matchIds.length) return { perGoalie:{}, dates:[] };

  const m = await sb.from('matches').select('id,date,opponent').in('id', matchIds).order('date',{ascending:true});
  if(m.error) throw m.error;

  const matchesById = Object.fromEntries(m.data.map(mm=>[mm.id, mm]));
  const dates = [...new Set(m.data.map(mm=>mm.date))].sort();

  const goalieById = Object.fromEntries(ALL_GOALIES.map(g=>[g.id, g]));
  const perGoalie = {};
  goalieIds.forEach(id => {
    const g = goalieById[id];
    perGoalie[id] = { id, code:g.code, name:g.name, series:[] };
  });

  st.data.forEach(row=>{
    const mm = matchesById[row.match_id]; if(!mm) return;
    perGoalie[row.goalie_id].series.push({ date:mm.date, opponent:mm.opponent, minutes:row.minutes, saves:row.saves, shots:row.shots });
  });

  for(const id of goalieIds){
    perGoalie[id].series.sort((a,b)=>a.date.localeCompare(b.date));
  }

  return { perGoalie, dates };
}

/* ===== Rendering ===== */
let svpctChart=null, srChart=null;

function renderTotals(cards){
  const wrap = $('#totals'); wrap.innerHTML='';
  cards.forEach(c=>{
    const div=document.createElement('div');
    div.className='rounded-2xl border shadow-sm p-3 bg-white';
    div.innerHTML=`
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm text-gray-500">Målvakt</div>
          <div class="text-lg font-semibold">${c.name} <span class="text-sm text-gray-500">(${c.code})</span></div>
        </div>
        <div class="text-right">
          <div class="text-sm text-gray-500">Rädd%</div>
          <div class="text-xl font-bold">${pct(c.saves, c.shots)}</div>
        </div>
      </div>
      <div class="grid grid-cols-3 gap-2 mt-3 text-center text-sm">
        <div class="rounded-xl border p-2"><div class="text-xs text-gray-500">Minuter</div><div class="font-semibold">${c.minutes}</div></div>
        <div class="rounded-xl border p-2"><div class="text-xs text-gray-500">Räddningar</div><div class="font-semibold">${c.saves}</div></div>
        <div class="rounded-xl border p-2"><div class="text-xs text-gray-500">Skott</div><div class="font-semibold">${c.shots}</div></div>
      </div>`;
    wrap.appendChild(div);
  });
}

function renderCharts(perGoalie, dates){
  const emptyLine = $('#empty-svpct');
  const emptyBar  = $('#empty-sr');

  // Save% overlay
  const datasets = [];
  let anyData = false;
  Object.values(perGoalie).forEach((g, i)=>{
    const map = Object.fromEntries(g.series.map(s=>[s.date, pctNum(s.saves, s.shots)]));
    const arr = dates.map(d => map[d] ?? null);
    if (arr.some(v=>v!=null)) anyData = true;
    datasets.push({ label:`${g.name} (${g.code})`, data:arr, spanGaps:true, tension:0.3, pointRadius:2, borderColor:palette(i) });
  });

  emptyLine.classList.toggle('hidden', anyData);
  if (svpctChart) svpctChart.destroy();
  if (anyData){
    svpctChart = new Chart($('#svpctChart').getContext('2d'), {
      type:'line',
      data:{ labels:dates, datasets },
      options:{
        responsive:true, maintainAspectRatio:false,
        scales:{ y:{ suggestedMin:60, suggestedMax:100, ticks:{ callback:v=>v+'%' } } },
        plugins:{ legend:{ position:'bottom' } }
      }
    });
  }

  // Bar chart: summa per datum
  const shotsPerDate = Object.fromEntries(dates.map(d=>[d,0]));
  const savesPerDate = Object.fromEntries(dates.map(d=>[d,0]));
  Object.values(perGoalie).forEach(g=>{
    g.series.forEach(s=>{ shotsPerDate[s.date]+=s.shots; savesPerDate[s.date]+=s.saves; });
  });
  const hasBars = dates.some(d => shotsPerDate[d]>0 || savesPerDate[d]>0);
  emptyBar.classList.toggle('hidden', hasBars);

  if (srChart) srChart.destroy();
  if (hasBars){
    srChart = new Chart($('#srChart').getContext('2d'), {
      type:'bar',
      data:{ labels: dates, datasets:[ { label:'Skott (summa)', data: dates.map(d=>shotsPerDate[d]) }, { label:'Räddningar (summa)', data: dates.map(d=>savesPerDate[d]) } ] },
      options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } }, plugins:{ legend:{ position:'bottom' } } }
    });
  }
}

/* ===== Export ===== */
function exportCSV(perGoalie){
  const head = ['goalie_code','goalie_name','date','opponent','minutes','saves','shots','save_pct'];
  const lines = [head.join(';')];
  Object.values(perGoalie).forEach(g=>{
    g.series.forEach(s=>{
      const p = s.shots>0 ? ((s.saves/s.shots)*100).toFixed(2) : '';
      lines.push([g.code, escCSV(g.name), `"${s.date}"`, escCSV(s.opponent||''), s.minutes, s.saves, s.shots, p].join(';'));
    });
  });
  const BOM = '\uFEFF'; download('mv_compare.csv', BOM + lines.join('\r\n'), 'text/csv');
}

/* ===== Jämför-knapp ===== */
async function compareNow(){
  $('#msg').textContent = '';
  const sel = $('#sel-goalies');
  const chosen = [...sel.selectedOptions].map(o=>o.value);
  if (chosen.length < 2 || chosen.length > 4){
    $('#msg').textContent = 'Välj 2–4 målvakter att jämföra.';
    return;
  }

  try{
    const { perGoalie, dates } = await fetchDataFor(chosen);

    const cards = Object.values(perGoalie).map(g=>{
      const minutes = g.series.reduce((a,s)=>a+s.minutes,0);
      const saves   = g.series.reduce((a,s)=>a+s.saves,0);
      const shots   = g.series.reduce((a,s)=>a+s.shots,0);
      return { code:g.code, name:g.name, minutes, saves, shots };
    }).sort((a,b)=>a.code.localeCompare(b.code));

    renderTotals(cards);
    renderCharts(perGoalie, dates);

    const btnExp = $('#btn-export');
    btnExp.disabled = false;
    btnExp.onclick = ()=>exportCSV(perGoalie);

  }catch(e){
    console.error(e);
    $('#msg').textContent = e?.message || String(e);
  }

  enableExport(perGoalie, dates);
}


function buildCompareCSVs(perGoalie, dates){
  const head1 = ['code','name','minutes','saves','shots','save_pct'];
  const lines1 = [head1.join(';')];
  Object.values(perGoalie).forEach(g=>{
    const minutes = g.series.reduce((a,b)=>a+(b.minutes||0),0);
    const saves   = g.series.reduce((a,b)=>a+(b.saves||0),0);
    const shots   = g.series.reduce((a,b)=>a+(b.shots||0),0);
    const p = shots>0?((saves/shots)*100).toFixed(2):'';
    lines1.push([g.code, escCSV(g.name), minutes, saves, shots, p].join(';'));
  });
  const goalies = Object.values(perGoalie);
  const head2 = ['date', ...goalies.map(g=>`${g.code}_svpct`)];
  const lines2 = [head2.join(';')];
  dates.forEach(d=>{
    const row = [d];
    goalies.forEach(g=>{
      const rec = g.series.find(s=>s.date===d);
      row.push(rec && rec.shots>0 ? ((rec.saves/rec.shots)*100).toFixed(2) : '');
    });
    lines2.push(row.join(';'));
  });
  const BOM='\uFEFF';
  return { totalsCSV: BOM+lines1.join('\r\n'), timelineCSV: BOM+lines2.join('\r\n') };
}
function enableExport(perGoalie, dates){
  const btn = document.getElementById('btn-export');
  btn.disabled = false;
  btn.onclick = () => {
    const { totalsCSV, timelineCSV } = buildCompareCSVs(perGoalie, dates);
    download('compare_totals.csv', totalsCSV, 'text/csv');
    download('compare_timeline.csv', timelineCSV, 'text/csv');
  };
}
/* ===== Boot ===== */
(async () => {
  $('#team-id').value = TEAM_ID || '(saknas – lägg ?team=...)';
  const s = await ensureSession();
  if(!s){ $('#msg').textContent='Ingen inloggning hittades. Gå till startsidan och logga in.'; return; }
  if(!TEAM_ID){ $('#msg').textContent='Saknar team i URL (?team=...)'; return; }
  await loadGoalies();
})();
document.getElementById('btn-compare').addEventListener('click', compareNow);
</script>

<script>
if ('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
</script>

</body>
</html>
