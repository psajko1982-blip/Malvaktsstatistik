<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>MV – Målvaktsstatistik (mobil)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
  </style>
</head>
<body class="bg-gray-50">
  <div class="mx-auto max-w-screen-sm p-3 sm:p-4">
    <div class="sticky top-0 z-10 -mx-3 -mt-3 mb-3 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 p-3 border-b">
      <h1 class="text-xl font-bold">MV – Målvaktsstatistik</h1>
      <p class="text-sm text-gray-600">Snabb registrering • Offline (localStorage) • Mobilvänlig</p>
    </div>

    <div class="rounded-2xl border shadow-sm p-3 mb-4" id="quickform">
      <div class="flex gap-2">
        <div class="flex-1">
          <label class="text-xs text-gray-500">Datum</label>
          <input id="f-date" type="date" class="w-full rounded-xl border p-2">
        </div>
        <div class="flex-1">
          <label class="text-xs text-gray-500">Motstånd</label>
          <input id="f-opp" type="text" placeholder="t.ex. Kumla" class="w-full rounded-xl border p-2">
        </div>
      </div>

      <div class="mt-2">
        <label class="text-xs text-gray-500">Resultat</label>
        <div class="grid grid-cols-3 gap-2 mt-1">
          <button data-res="V" class="resbtn rounded-xl border py-2 text-sm">Vinst</button>
          <button data-res="O" class="resbtn rounded-xl border py-2 text-sm">Oavgjort</button>
          <button data-res="F" class="resbtn rounded-xl border py-2 text-sm">Förlust</button>
        </div>
      </div>

      <div class="mt-3">
        <div class="flex items-center justify-between mb-1">
          <label class="text-xs text-gray-500">Målvakter (min / räddningar / skott)</label>
          <button id="reset-entries" class="text-xs underline">Nollställ</button>
        </div>
        <div id="goalie-grid" class="space-y-2"></div>
      </div>

      <button id="add-match" class="mt-3 w-full rounded-2xl bg-black text-white py-3 font-medium">Lägg till match</button>
    </div>

    <div id="cards" class="grid sm:grid-cols-2 gap-3 mb-4"></div>

    <div class="rounded-2xl border shadow-sm p-3 mb-4">
      <div class="text-sm text-gray-500">Resultat</div>
      <div class="grid grid-cols-3 gap-2 mt-2 text-center">
        <div class="rounded-xl border p-2"><div class="text-xs text-gray-500">Vinst</div><div id="stat-v" class="text-lg font-semibold">0</div></div>
        <div class="rounded-xl border p-2"><div class="text-xs text-gray-500">Oavgjort</div><div id="stat-o" class="text-lg font-semibold">0</div></div>
        <div class="rounded-xl border p-2"><div class="text-xs text-gray-500">Förlust</div><div id="stat-f" class="text-lg font-semibold">0</div></div>
      </div>
      <div class="text-xs text-gray-500 mt-2">Tot. minuter (alla målvakter): <span id="stat-min" class="font-medium text-gray-700">0</span></div>
    </div>

    <div id="match-list" class="space-y-3 mb-24"></div>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-3">
      <div class="mx-auto max-w-screen-sm grid grid-cols-4 gap-2">
        <button id="btn-exp-csv" class="rounded-xl border py-2 text-sm">Export CSV</button>
        <button id="btn-exp-json" class="rounded-xl border py-2 text-sm">Export JSON</button>
        <label class="rounded-xl border py-2 text-sm text-center cursor-pointer">
          <input id="imp-csv" type="file" accept=".csv" class="hidden">Import CSV
        </label>
        <label class="rounded-xl border py-2 text-sm text-center cursor-pointer">
          <input id="imp-json" type="file" accept=".json" class="hidden">Import JSON
        </label>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'mv_goalie_app_v1';
    const DEFAULT_GOALIES = [
      { id: 'LL', name: 'Leo L' },
      { id: 'IE', name: 'Isac E' },
      { id: 'EH', name: 'Emil H' },
      { id: 'LK', name: 'Leo K' },
    ];

    const uid = () => Math.random().toString(36).slice(2, 10);
    const today = () => new Date().toISOString().slice(0,10);

    let state = { goalies: DEFAULT_GOALIES, matches: [] };

    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) state = JSON.parse(raw);
    } catch {}

    const el = (sel) => document.querySelector(sel);
    const grid = el('#goalie-grid');
    const list = el('#match-list');

    // init form
    el('#f-date').value = today();
    let formResult = 'V';

    document.querySelectorAll('.resbtn').forEach(btn => {
      const setActive = () => {
        document.querySelectorAll('.resbtn').forEach(b => b.classList.remove('border-black'));
        btn.classList.add('border-black');
      };
      btn.addEventListener('click', () => { formResult = btn.dataset.res; setActive(); });
      if (btn.dataset.res === 'V') setActive();
    });

    function num(v){ const n = Number(String(v||'').replace(',', '.')); return Number.isFinite(n) ? n : 0; }

    function renderGoalieInputs(){
      grid.innerHTML='';
      state.goalies.forEach(g => {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-12 items-center gap-2';
        row.innerHTML = `
          <div class="col-span-4">
            <div class="font-medium text-sm">${g.name}</div>
            <div class="text-xs text-gray-500">${g.id}</div>
          </div>
          <input id="m-${g.id}" inputmode="numeric" class="col-span-2 rounded-xl border p-2 text-center" placeholder="min" value="0" />
          <input id="s-${g.id}" inputmode="numeric" class="col-span-3 rounded-xl border p-2 text-center" placeholder="räddn" value="0" />
          <input id="t-${g.id}" inputmode="numeric" class="col-span-3 rounded-xl border p-2 text-center" placeholder="skott" value="0" />
        `;
        grid.appendChild(row);
      });
    }

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    function pct(saves, shots){ return shots > 0 ? saves/shots : null; }
    function sum(arr){ return arr.reduce((a,v)=>a+(Number.isFinite(v)?v:0), 0); }

    function renderCards(){
      const wrap = document.getElementById('cards');
      wrap.innerHTML='';
      state.goalies.forEach(g => {
        const all = state.matches.flatMap(m => m.entries.filter(e=>e.goalieId===g.id));
        const minutes = sum(all.map(e=>e.minutes));
        const saves = sum(all.map(e=>e.saves));
        const shots = sum(all.map(e=>e.shots));
        const p = pct(saves, shots);
        const card = document.createElement('div');
        card.className = 'rounded-2xl border shadow-sm p-3';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-gray-500">Målvakt</div>
              <div class="text-lg font-semibold">${g.name} <span class="text-sm text-gray-500">(${g.id})</span></div>
            </div>
            <div class="text-right">
              <div class="text-sm text-gray-500">Rädd%</div>
              <div class="text-xl font-bold">${p===null? '–' : (p*100).toFixed(2)+'%'}</div>
            </div>
          </div>
          <div class="grid grid-cols-3 gap-2 mt-3 text-center text-sm">
            <div class="rounded-xl border p-2"><div class="text-xs text-gray-500">Minuter</div><div class="font-semibold">${minutes}</div></div>
            <div class="rounded-xl border p-2"><div class="text-xs text-gray-500">Räddningar</div><div class="font-semibold">${saves}</div></div>
            <div class="rounded-xl border p-2"><div class="text-xs text-gray-500">Skott</div><div class="font-semibold">${shots}</div></div>
          </div>
        `;
        wrap.appendChild(card);
      });
    }

    function renderResultSummary(){
      const v = state.matches.filter((m) => m.result === "V").length;
      const o = state.matches.filter((m) => m.result === "O").length;
      const f = state.matches.filter((m) => m.result === "F").length;
      document.getElementById('stat-v').textContent = v;
      document.getElementById('stat-o').textContent = o;
      document.getElementById('stat-f').textContent = f;
      const minutesTotal = state.goalies.map(g=>
        state.matches.flatMap(m=>m.entries.filter(e=>e.goalieId===g.id)).reduce((a,e)=>a+e.minutes,0)
      ).reduce((a,b)=>a+b,0);
      document.getElementById('stat-min').textContent = minutesTotal;
    }

    function renderMatchList(){
      list.innerHTML='';
      if (!state.matches.length){
        const empty = document.createElement('div');
        empty.className='text-center text-sm text-gray-500';
        empty.textContent='Inga matcher ännu. Lägg till första ovan.';
        list.appendChild(empty);
        return;
      }
      state.matches.forEach(m => {
        const box = document.createElement('div');
        box.className='rounded-2xl border shadow-sm';
        const header = document.createElement('div');
        header.className='flex items-center justify-between p-3';
        header.innerHTML = `
          <div>
            <div class="text-sm font-semibold">${m.opponent || 'Motstånd saknas'}</div>
            <div class="text-xs text-gray-500">${m.date} • ${m.result==='V'?'Vinst':m.result==='O'?'Oavgjort':'Förlust'}</div>
          </div>
          <button class="text-xs underline">Ta bort</button>
        `;
        header.querySelector('button').addEventListener('click', ()=>{
          state.matches = state.matches.filter(x=>x.id!==m.id); save(); redraw();
        });
        const body = document.createElement('div');
        body.className='border-t p-3';
        const head = document.createElement('div');
        head.className='grid grid-cols-12 text-xs font-medium text-gray-500';
        head.innerHTML='<div class="col-span-4">Målvakt</div><div class="col-span-2 text-center">Min</div><div class="col-span-3 text-center">Räddn</div><div class="col-span-3 text-center">Skott</div>';
        body.appendChild(head);
        m.entries.forEach(e=>{
          if ((e.minutes||0)+(e.saves||0)+(e.shots||0)===0) return;
          const g = state.goalies.find(x=>x.id===e.goalieId); if(!g) return;
          const row = document.createElement('div');
          row.className='grid grid-cols-12 items-center py-1';
          row.innerHTML = `<div class="col-span-4 text-sm">${g.name} <span class="text-gray-500">(${g.id})</span></div>
                           <div class="col-span-2 text-center">${e.minutes}</div>
                           <div class="col-span-3 text-center">${e.saves}</div>
                           <div class="col-span-3 text-center">${e.shots}</div>`;
          body.appendChild(row);
        });
        box.appendChild(header); box.appendChild(body);
        list.appendChild(box);
      });
    }

    function redraw(){ renderGoalieInputs(); renderCards(); renderResultSummary(); renderMatchList(); }

    // actions
    document.getElementById('reset-entries').addEventListener('click', ()=>{
      state.goalies.forEach(g=>{
        el('#m-'+g.id).value='0';
        el('#s-'+g.id).value='0';
        el('#t-'+g.id).value='0';
      });
    });

    document.getElementById('add-match').addEventListener('click', ()=>{
      const entries = state.goalies.map(g=>({
        goalieId: g.id,
        minutes: num(el('#m-'+g.id).value),
        saves: num(el('#s-'+g.id).value),
        shots: num(el('#t-'+g.id).value),
      }));
      const match = {
        id: uid(),
        date: el('#f-date').value || today(),
        opponent: el('#f-opp').value || '',
        result: formResult,
        entries,
      };
      state.matches = [match, ...state.matches];
      save(); redraw();
      // quick clear except date
      document.querySelectorAll('#goalie-grid input').forEach(i=> i.value='0');
      el('#f-opp').value='';
    });

    // Export/Import
    function download(filename, content, mime){
      const blob = new Blob([content], {type: mime+';charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
    }

    function toCSV(){
      const header = ['date','opponent','result', ...state.goalies.flatMap(g=>[`${g.id}_minutes`, `${g.id}_saves`, `${g.id}_shots`]), 'notes'];
      const rows = state.matches.map(m=>{
        const map = Object.fromEntries(m.entries.map(e=>[e.goalieId, e]));
        const cols = [m.date, esc(m.opponent), m.result, ...state.goalies.flatMap(g=>{
          const e = map[g.id]||{}; return [e.minutes??'', e.saves??'', e.shots??''];
        }), esc(m.notes||'')];
        return cols.join(';');
      });
      return [header.join(';'), ...rows].join('\n');
    }
    function esc(v){ return /[;"\n]/.test(String(v)) ? '"'+String(v).replaceAll('"','""')+'"' : String(v); }

    document.getElementById('btn-exp-csv').addEventListener('click', ()=> download('mv_export.csv', toCSV(), 'text/csv'));
    document.getElementById('btn-exp-json').addEventListener('click', ()=> download('mv_export.json', JSON.stringify(state, null, 2), 'application/json'));

    document.getElementById('imp-csv').addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0]; if(!f) return; const r = new FileReader();
      r.onload = ()=>{
        const text = String(r.result||'');
        const lines = text.split(/\r?\n/).filter(Boolean);
        if (lines.length<2) return;
        const header = lines[0].split(';');
        const idx = Object.fromEntries(header.map((h,i)=>[h.trim(), i]));
        const matches = lines.slice(1).map(line=>{
          const cols = parseCSV(line);
          const entries = state.goalies.map(g=>({
            goalieId: g.id,
            minutes: toNum(cols[idx[`${g.id}_minutes`]]),
            saves: toNum(cols[idx[`${g.id}_saves`]]),
            shots: toNum(cols[idx[`${g.id}_shots`]]),
          }));
          return { id: uid(), date: cols[idx['date']]||today(), opponent: cols[idx['opponent']]||'', result: cols[idx['result']]||'V', entries };
        });
        state.matches = [...matches, ...state.matches]; save(); redraw();
      };
      r.readAsText(f);
      e.target.value='';
    });

    function toNum(v){ const n = Number(String(v||'').replace(',', '.')); return Number.isFinite(n)?n:0; }

    document.getElementById('imp-json').addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0]; if(!f) return; const r = new FileReader();
      r.onload = ()=>{
        try { const obj = JSON.parse(String(r.result||'{}')); if(obj.goalies && obj.matches){ state=obj; save(); redraw(); } } catch {}
      };
      r.readAsText(f);
      e.target.value='';
    });

    function parseCSV(line){
      const out=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(inQ){ if(ch==='"'){ if(line[i+1]==='"'){ cur+='"'; i++; } else { inQ=false; } } else { cur+=ch; } }
        else { if(ch==='"') inQ=true; else if(ch===';'){ out.push(cur); cur=''; } else { cur+=ch; } }
      }
      out.push(cur); return out;
    }

    function init(){ renderGoalieInputs(); redraw(); }
    init();
  </script>
</body>
</html>
