<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Målvaktsstatistik</title>

  <!-- Tailwind (CDN för enkelhet) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
  </style>

  <!-- manifest är frivillig - ta bort raden om du inte använder PWA -->
  <!-- <link rel="manifest" href="manifest.webmanifest"> -->
</head>
<body class="bg-slate-100 text-slate-900">
<div class="min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-slate-900 text-white">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-full bg-sky-500 flex items-center justify-center text-lg font-bold">
          MV
        </div>
        <div>
          <div class="font-semibold leading-tight">Målvaktsstatistik</div>
          <div class="text-xs text-slate-300">
            Fokuserat på målvakten - skott, räddningar, mål, xG &amp; skottkarta
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3 text-xs">
        <div id="auth-area" class="hidden">
          <div id="auth-user" class="text-right mb-1"></div>
          <button id="btn-signout"
                  class="px-3 py-1 border border-slate-500 rounded-full hover:bg-slate-800">
            Logga ut
          </button>
        </div>
        <button id="btn-auth"
                class="px-3 py-1 border border-slate-500 rounded-full hover:bg-slate-800">
          Logga in / Skapa konto
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1">
    <div class="max-w-5xl mx-auto px-4 py-4">

      <!-- Team / date row -->
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <div>
          <label class="block text-xs text-slate-500 mb-1">Mitt lag</label>
          <select id="team-select"
                  class="rounded-xl border border-slate-300 px-3 py-1.5 text-sm bg-white min-w-[200px]">
          </select>
        </div>
        <button id="btn-new-team"
                class="text-xs px-3 py-1.5 border border-slate-300 rounded-xl bg-white hover:bg-slate-50">
          + Nytt lag
        </button>

        <div class="ml-auto flex items-center gap-2 text-xs text-slate-500">
          <span>Datumfilter:</span>
          <input id="filter-from" type="date"
                 class="border rounded px-2 py-1 text-xs">
          <span>-</span>
          <input id="filter-to" type="date"
                 class="border rounded px-2 py-1 text-xs">
          <button id="btn-clear-filter"
                  class="text-[11px] px-2 py-1 border rounded-lg hover:bg-slate-50">
            Rensa
          </button>
        </div>
      </div>

      <!-- Summary row -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
        <div class="bg-white rounded-2xl p-3 shadow-sm">
          <div class="flex items-center justify-between mb-2">
            <div>
              <div class="text-xs text-slate-500">Matcher</div>
              <div id="summary-matches" class="text-xl font-semibold">-</div>
            </div>
            <div class="text-right text-[11px] text-slate-500">
              <div id="summary-result" class="font-medium">-</div>
              <div>V / O / F</div>
            </div>
          </div>
          <div class="mt-1 text-[11px] text-slate-500">
            Filter påverkar statistiken nedan.
          </div>
        </div>

        <div class="bg-white rounded-2xl p-3 shadow-sm">
          <div class="flex items-center justify-between mb-2">
            <div>
              <div class="text-xs text-slate-500">Totalt skott på mål</div>
              <div id="summary-shots" class="text-xl font-semibold">-</div>
            </div>
            <div class="text-right text-[11px] text-slate-500">
              <div class="font-medium" id="summary-goals">-</div>
              <div>Insläppta mål</div>
            </div>
          </div>
          <div class="mt-1 text-[11px] text-slate-500">
            Inklusive alla målvakter i laget.
          </div>
        </div>

        <div class="bg-white rounded-2xl p-3 shadow-sm">
          <div class="flex items-center justify-between mb-2">
            <div>
              <div class="text-xs text-slate-500">Genomsnittlig räddningsprocent</div>
              <div id="summary-svpct" class="text-xl font-semibold">-</div>
            </div>
            <div class="text-right text-[11px] text-slate-500">
              <div id="summary-goalies" class="font-medium">-</div>
              <div>Målvakter med matcher</div>
            </div>
          </div>
          <div class="mt-1 text-[11px] text-slate-500">
            Beräknas på totala skott &amp; mål per målvakt.
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="mb-3 border-b border-slate-200 flex gap-4 text-sm">
        <button data-tab="tab-matches"
                class="tab-btn border-b-2 border-sky-500 text-sky-600 pb-2 -mb-px">
          Matcher
        </button>
        <button data-tab="tab-goalies"
                class="tab-btn pb-2 text-slate-500">
          Målvakter
        </button>
        <button data-tab="tab-import"
                class="tab-btn pb-2 text-slate-500">
          Import / Export
        </button>
      </div>

      <!-- Tab: Matches -->
      <section id="tab-matches" class="tab-pane">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-base font-semibold">Matcher</h2>
          <button id="btn-new-match"
                  class="px-3 py-1.5 rounded-xl bg-sky-600 text-white text-sm hover:bg-sky-700">
            + Ny match
          </button>
        </div>
        <div id="matches-wrap" class="space-y-3"></div>
        <div id="matches-empty" class="hidden text-sm text-slate-500 mt-4">
          Inga matcher ännu. Klicka på <b>Ny match</b> för att lägga till.
        </div>
      </section>

      <!-- Tab: Goalies -->
      <section id="tab-goalies" class="tab-pane hidden">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-base font-semibold">Målvakter</h2>
          <button id="btn-new-goalie"
                  class="px-3 py-1.5 rounded-xl bg-sky-600 text-white text-sm hover:bg-sky-700">
            + Ny målvakt
          </button>
        </div>
        <div id="goalies-wrap" class="space-y-3"></div>
        <div id="goalies-empty" class="hidden text-sm text-slate-500 mt-4">
          Inga målvakter ännu. Lägg till en för att bärja.
        </div>
      </section>

      <!-- Tab: Import / Export -->
      <section id="tab-import" class="tab-pane hidden">
        <h2 class="text-base font-semibold mb-2">Import / Export</h2>

        <div class="bg-white rounded-2xl p-3 shadow-sm mb-3">
          <div class="text-sm font-medium mb-1">Exportera data</div>
          <div class="text-xs text-slate-500 mb-2">
            Exportera alla målvakter, matcher och skott som JSON.
          </div>
          <button id="btn-export-json"
                  class="px-3 py-1.5 rounded-xl border border-slate-300 text-sm hover:bg-slate-50">
            Ladda ner JSON
          </button>
        </div>

        <div class="bg-white rounded-2xl p-3 shadow-sm mb-3">
          <div class="text-sm font-medium mb-1">Importera data</div>
          <div class="text-xs text-slate-500 mb-2">
            JSON: innehåller målvakter, matcher och skott (export från appen).<br>
            CSV: endast matcher &amp; statistik (t.ex. från Excel). CSV använder semikolon
            (<code>;</code>) som avgränsare.
          </div>

          <div class="flex flex-wrap gap-2">
            <label class="rounded-xl border px-3 py-2 text-center cursor-pointer text-sm">
              <input id="imp-json" type="file" accept=".json" class="hidden">
              Import JSON
            </label>
            <label class="rounded-xl border px-3 py-2 text-center cursor-pointer text-sm">
              <input id="imp-csv" type="file" accept=".csv" class="hidden">
              Import CSV
            </label>
          </div>

          <div class="text-xs text-gray-500 mt-2">
            JSON innehåller målvakter + matcher + skott. CSV är semikolon-separerad
            med rubriker. Import gär upsert (datum+motstånd) och ersätter stats för matchen.
          </div>
        </div>
      </section>

    </div>
  </main>
</div>

<!-- Modal: Lägg skott (enklare modal - används vid behov) -->
<div id="shot-modal"
     class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
  <div class="bg-white rounded-2xl p-4 w-full max-w-md">
    <div class="flex items-center justify-between mb-2">
      <div class="font-semibold">
        Lägg skott - <span id="shot-modal-code"></span>
      </div>
      <button type="button" class="text-sm underline" onclick="closeShotModal()">Stäng</button>
    </div>
    <div class="text-xs text-gray-500 mb-1">
      Klicka på rinken för att lägga skott
    </div>

    <div id="shot-rink"
         class="relative w-full border rounded-xl bg-slate-100 overflow-hidden"
         style="aspect-ratio: 200/85; cursor: crosshair;">
      <svg viewBox="0 0 200 85"
           class="absolute inset-0 w-full h-full pointer-events-none">
        <rect x="0" y="0" width="200" height="85" rx="10" ry="10"
              fill="#f8fafc" stroke="#e5e7eb"/>
        <line x1="100" y1="0" x2="100" y2="85"
              stroke="#e11d48" stroke-width="0.8"/>
        <rect x="0"   y="30" width="5" height="25" fill="#fee2e2"/>
        <rect x="195" y="30" width="5" height="25" fill="#fee2e2"/>
      </svg>
      <div id="shot-dots" class="absolute inset-0"></div>
    </div>

    <div class="mt-3 flex items-center justify-between gap-2 text-xs">
      <div class="flex-1">
        <label class="block text-[11px] text-gray-500 mb-1">Resultat</label>
        <select id="shot-result"
                class="border rounded px-2 py-1 w-full text-xs">
          <option value="save">Räddning</option>
          <option value="goal">Mål</option>
          <option value="miss">Utanför</option>
          <option value="post">Ribba/Stolpe</option>
        </select>
      </div>
      <div class="flex-1">
        <label class="block text-[11px] text-gray-500 mb-1">Period</label>
        <select id="shot-period"
                class="border rounded px-2 py-1 w-full text-xs">
          <option value="1">1:a</option>
          <option value="2">2:a</option>
          <option value="3">3:e</option>
          <option value="OT">Övertid</option>
        </select>
      </div>
      <div class="flex-1">
        <label class="block text-[11px] text-gray-500 mb-1">Tid (mm:ss)</label>
        <input id="shot-time" type="text"
               class="border rounded px-2 py-1 w-full text-xs"
               placeholder="t.ex. 12:34">
      </div>
    </div>

    <div class="mt-4 flex justify-end gap-2">
      <button type="button"
              class="px-3 py-1.5 text-sm border rounded-xl"
              onclick="closeShotModal()">
        Avbryt
      </button>
      <button id="shot-save" type="button"
              class="px-3 py-1.5 text-sm rounded-xl bg-sky-600 text-white hover:bg-sky-700">
        Spara skott
      </button>
    </div>
  </div>
</div>

<!-- Modal: Redigera match -->
<div id="edit-modal"
     class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
  <div class="bg-white rounded-2xl p-4 w-full max-w-lg max-h-[90vh] flex flex-col">
    <div class="flex items-center justify-between mb-2">
      <div class="font-semibold">Redigera match</div>
      <button type="button" class="text-sm underline" onclick="closeEditModal()">Stäng</button>
    </div>
    <div id="edit-body" class="flex-1 overflow-auto text-sm">
      <!-- Fylls dynamiskt -->
    </div>
    <div class="mt-3 flex justify-end gap-2">
      <button type="button"
              class="px-3 py-1.5 text-sm border rounded-xl"
              onclick="closeEditModal()">
        Avbryt
      </button>
      <button id="edit-save" type="button"
              class="px-3 py-1.5 text-sm rounded-xl bg-sky-600 text-white hover:bg-sky-700">
        Spara ändringar
      </button>
    </div>
  </div>
</div>

<!-- Auth-modal -->
<div id="auth-modal"
     class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
  <div class="bg-white rounded-2xl p-4 w-full max-w-sm">
    <div class="flex items-center justify-between mb-2">
      <div class="font-semibold">Logga in / Skapa konto</div>
      <button type="button" class="text-sm underline" onclick="closeAuthModal()">Stäng</button>
    </div>
    <div class="space-y-2 text-sm">
      <div>
        <label class="block text-xs text-gray-500 mb-1">E-post</label>
        <input id="auth-email" type="email"
               class="border rounded px-2 py-1 w-full text-sm">
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Lösenord</label>
        <input id="auth-password" type="password"
               class="border rounded px-2 py-1 w-full text-sm">
      </div>
      <div class="text-xs text-gray-500">
        Kontot används för att spara dina lag, målvakter, matcher och skott i molnet (Supabase).
      </div>
      <div class="flex gap-2 mt-2">
        <button id="auth-signin"
                class="flex-1 px-3 py-1.5 rounded-xl bg-sky-600 text-white text-sm hover:bg-sky-700">
          Logga in
        </button>
        <button id="auth-signup"
                class="flex-1 px-3 py-1.5 rounded-xl border text-sm hover:bg-slate-50">
          Skapa konto
        </button>
      </div>
    </div>
    <div id="auth-msg" class="text-sm text-red-600 mt-2"></div>
  </div>
</div>

<!-- Skottkarta / Skott-editor (ny modal) -->
<div id="shot-editor-modal"
     class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
    <div class="flex items-center justify-between px-6 py-4 border-b">
      <h2 class="text-lg font-semibold">Skottkarta - redigera skott</h2>
      <button id="shot-editor-close"
              class="text-sm text-gray-500 hover:text-gray-700">Stäng</button>
    </div>

    <div class="px-6 pt-4 pb-3 flex flex-wrap gap-4 items-center border-b">
      <div>
        <label class="block text-xs text-gray-500 mb-1">Målvakt</label>
        <select id="shot-editor-goalie" class="border rounded px-2 py-1 text-sm">
          <!-- fylls via JS -->
        </select>
      </div>

      <div>
        <span class="block text-xs text-gray-500 mb-1">Resultat</span>
        <div class="flex gap-3 text-sm">
          <label><input type="radio" name="shot-result" value="goal" checked> Mål</label>
          <label><input type="radio" name="shot-result" value="save"> Räddning</label>
          <label><input type="radio" name="shot-result" value="miss"> Miss</label>
          <label><input type="radio" name="shot-result" value="post"> Ribba/stolpe</label>
        </div>
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Period</label>
        <select id="shot-editor-period" class="border rounded px-2 py-1 text-sm">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="OT">OT</option>
        </select>
      </div>

      <p class="text-xs text-gray-500 flex-1">
        Klicka på isen för att lägga till skott. Välj målvakt och resultat ovan.  
        Klicka på "Ta bort" i listan nedan för att radera ett skott.
      </p>
    </div>

    <div class="p-6 flex-1 overflow-hidden flex flex-col gap-4">
      <!-- Själva isen / skottkartan -->
      <div class="flex-1 flex items-center justify-center">
        <div class="relative border rounded-xl overflow-hidden bg-sky-50"
             style="width: 100%; max-width: 900px; aspect-ratio: 2 / 1;">
          <canvas id="shot-editor-canvas" class="w-full h-full"></canvas>
        </div>
      </div>

      <!-- Lista med skott -->
      <div class="h-40 overflow-y-auto border rounded-lg">
        <table class="w-full text-xs">
          <thead class="bg-gray-50">
          <tr>
            <th class="px-2 py-1 text-left">Målvakt</th>
            <th class="px-2 py-1 text-left">Resultat</th>
            <th class="px-2 py-1 text-left">Period</th>
            <th class="px-2 py-1 text-left">X</th>
            <th class="px-2 py-1 text-left">Y</th>
            <th class="px-2 py-1"></th>
          </tr>
          </thead>
          <tbody id="shot-editor-list"></tbody>
        </table>
      </div>
    </div>

    <div class="px-6 py-4 border-t flex justify-end gap-3">
      <button id="shot-editor-cancel"
              class="px-4 py-2 text-sm rounded border">
        Avbryt
      </button>
      <button id="shot-editor-save"
              class="px-4 py-2 text-sm rounded bg-blue-600 text-white hover:bg-blue-700">
        Spara skott
      </button>
    </div>
  </div>
</div>

<script>
  // ---------- Supabase config ----------
  const SUPABASE_URL = "https://okdvcvbmgposbhvrygop.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rZHZjdmJtZ3Bvc2JodnJ5Z29wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2ODgyMjUsImV4cCI6MjA3MzI2NDIyNX0.w4SCljFULEduafWZexzmQqyG08pGoUFOeSCbfuCFaJg";
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ---------- Hjälpfunktioner ----------
  const $  = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function fmtPct(num) {
    if (num == null || isNaN(num)) return "-";
    return (num*100).toFixed(1).replace(".", ",") + " %";
  }
  function fmtInt(num) {
    if (num == null || isNaN(num)) return "-";
    return String(Math.round(num));
  }
  function fmtDate(str) {
    if (!str) return "";
    try {
      const d = new Date(str);
      if (Number.isNaN(d.getTime())) return str;
      return d.toLocaleDateString("sv-SE");
    } catch(e) { return str; }
  }
  function fmtTimeMin(min) {
    if (min == null || isNaN(min)) return "-";
    return `${min.toFixed(1).replace(".", ",")} min`;
  }
  function showError(where, err) {
    console.error(`Error in ${where}`, err);

    let msg = "Okänt fel";
    if (err) {
      if (err.message) msg = err.message;
      else if (err.error_description) msg = err.error_description;
      else if (err.details) msg = err.details;
      else {
        try { msg = JSON.stringify(err); } catch (_) {}
      }
    }

    alert(`Något gick fel (${where}):\n\n${msg}`);
  }


  // ---------- Auth ----------
  let CURRENT_USER  = null;
  let CURRENT_TEAM_ID = null;
  let GOALIES = [];

  async function refreshUser() {
    const { data, error } = await supabaseClient.auth.getUser();
    if (error || !data.user) CURRENT_USER = null;
    else CURRENT_USER = data.user;
    renderAuth();
  }

  function renderAuth() {
    const authArea  = $("#auth-area");
    const authBtn   = $("#btn-auth");
    const authUser  = $("#auth-user");
    const btnSignout= $("#btn-signout");

    if (CURRENT_USER) {
      authArea.classList.remove("hidden");
      authBtn.classList.add("hidden");
      authUser.textContent = CURRENT_USER.email || "Inloggad";
      btnSignout.onclick = async () => {
        await supabaseClient.auth.signOut();
        CURRENT_USER = null;
        renderAuth();
        await initTeams();
        await refreshAll();
      };
    } else {
      authArea.classList.add("hidden");
      authBtn.classList.remove("hidden");
    }
  }

  function openAuthModal(){
    $("#auth-modal").classList.remove("hidden");
    $("#auth-modal").classList.add("flex");
    $("#auth-msg").textContent = "";
  }
  function closeAuthModal(){
    $("#auth-modal").classList.add("hidden");
    $("#auth-modal").classList.remove("flex");
  }

  async function handleAuth(action){
    const email = $("#auth-email").value.trim();
    const password = $("#auth-password").value;
    const msgEl = $("#auth-msg");
    msgEl.textContent = "";
    if (!email || !password){
      msgEl.textContent = "Fyll i både e-post och läsenord.";
      return;
    }
    try{
      if (action === "signin"){
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) throw error;
        CURRENT_USER = data.user;
        closeAuthModal();
        renderAuth();
        await initTeams();
        await refreshAll();
      } else {
        const { data, error } = await supabaseClient.auth.signUp({ email, password });
        if (error) throw error;
        CURRENT_USER = data.user;
        msgEl.textContent = "Konto skapat! Du är inloggad.";
        renderAuth();
        await initTeams();
        await refreshAll();
        setTimeout(closeAuthModal, 800);
      }
    } catch(e){
      console.error(e);
      msgEl.textContent = e.message || "Kunde inte logga in / skapa konto.";
    }
  }

  // ---------- DB helpers ----------
  async function dbMyTeams(){
    const { data, error } = await supabaseClient
      .from("teams").select("*").order("created_at",{ascending:true});
    if (error) throw error;
    return data || [];
  }

  async function dbCreateTeam(name){
    const { data, error } = await supabaseClient
      .from("teams").insert([{ name }]).select().single();
    if (error) throw error;
    return data;
  }

  async function dbGoalies(teamId){
    const { data, error } = await supabaseClient
      .from("goalies")
      .select("*")
      .eq("team_id", teamId)
      .order("code",{ascending:true});
    if (error) throw error;
    return data || [];
  }

  // Hämta matcher + ev. statistik från match_goalie_stats
  async function dbMatches(teamId, fromDate, toDate){
    let q = supabaseClient
      .from("matches")
      .select("*")
      .eq("team_id", teamId)
      .order("date", { ascending: false })
      .order("id", { ascending: false });

    if (fromDate) q = q.gte("date", fromDate);
    if (toDate)   q = q.lte("date", toDate);

    const { data: matches, error } = await q;
    if (error) throw error;

    const matchList = matches || [];
    const matchIds  = matchList.map(m => m.id);

    let statsByMatch = {};

    if (matchIds.length){
      try {
        const { data: statsRows, error: statsErr } = await supabaseClient
          .from("match_goalie_stats")
          .select("match_id, goalie_id, minutes, shots, goals")
          .in("match_id", matchIds);

        if (statsErr) {
          console.warn("match_goalie_stats error:", statsErr);
        } else if (statsRows && statsRows.length) {
          statsByMatch = statsRows.reduce((acc, row) => {
            if (!acc[row.match_id]) acc[row.match_id] = {};

            const shots = row.shots || 0;
            const goals = row.goals || 0;

            acc[row.match_id][row.goalie_id] = {
              minutes: row.minutes || 0,
              shots,
              goals
            };
            return acc;
          }, {});
        }
      } catch (e) {
        console.warn("match_goalie_stats fatal error:", e);
      }
    }

    return matchList.map(m => {
      const statsForMatch = statsByMatch[m.id];
      if (!statsForMatch) return m;
      return {
        ...m,
        stats_json: JSON.stringify(statsForMatch)
      };
    });
  }

  async function dbCreateGoalie(teamId, code, name){
    const { data, error } = await supabaseClient
      .from("goalies")
      .insert([{ team_id: teamId, code, name }])
      .select().single();
    if (error) throw error;
    return data;
  }

  async function dbCreateMatch(teamId, payload){
    const { data, error } = await supabaseClient
      .from("matches")
      .insert([{ team_id: teamId, ...payload }])
      .select().single();
    if (error) throw error;
    return data;
  }

  async function dbUpdateMatch(id, payload){
    const { error } = await supabaseClient
      .from("matches")
      .update(payload)
      .eq("id", id);
    if (error) throw error;
  }

  async function dbDeleteMatch(id){
    const { error } = await supabaseClient
      .from("matches")
      .delete()
      .eq("id", id);
    if (error) throw error;
  }

  async function dbLoadShotsForMatch(matchId){
    const { data, error } = await supabaseClient
      .from("shots")
      .select("*")
      .eq("match_id", matchId);
    if (error) throw error;
    return data || [];
  }

  function normalizeShotResult(result){
    const r = String(result || "").trim().toLowerCase();
    if (!r) return "save";
    const map = {
      "goal": "goal",
      "mål": "goal",
      "mal": "goal",
      "save": "save",
      "räddning": "save",
      "raddning": "save",
      "miss": "miss",
      "post": "post",
      "ribba": "post",
      "stolpe": "post",
      "ribba/stolpe": "post",
      "ribba och stolpe": "post"
    };
    if (map[r]) return map[r];
    if (r.startsWith("goal")) return "goal";
    if (r.startsWith("save")) return "save";
    if (r.startsWith("miss")) return "miss";
    if (r.startsWith("post")) return "post";
    return "save";
  }

  async function dbAddShot(shot){
    // se till att team_id alltid följer med
    const row = {
      ...shot,
      team_id: CURRENT_TEAM_ID,
      result: normalizeShotResult(shot.result)
    };

    const { data, error } = await supabaseClient
      .from("shots")
      .insert([row])
      .select()
      .single();

    if (error) throw error;
    return data;
  }


  // ersätt alla skott för en match (används av editorn)
  async function dbReplaceShotsForMatch(matchId, shots){
    const { error: delErr } = await supabaseClient
      .from("shots")
      .delete()
      .eq("match_id", matchId);
    if (delErr) throw delErr;

    if (!shots.length) return;

    const rows = shots.map(s => ({
      match_id: matchId,
      team_id: CURRENT_TEAM_ID,          // ?? lägg till team_id här
      goalie_id: s.goalie_id,
      result: normalizeShotResult(s.result),
      period: s.period || null,
      time: s.time || null,
      x: s.x,
      y: s.y
    }));

    const { error: insErr } = await supabaseClient
      .from("shots")
      .insert(rows);
    if (insErr) throw insErr;
  }


  // match_goalie_stats helpers
  async function dbMatchStatsBulk(matchIds){
    if (!matchIds.length) return [];
    const { data, error } = await supabaseClient
      .from("match_goalie_stats")
      .select("*")
      .in("match_id", matchIds);
    if (error) throw error;
    return data || [];
  }

  async function dbMatchStatsForMatch(matchId){
    const { data, error } = await supabaseClient
      .from("match_goalie_stats")
      .select("*")
      .eq("match_id", matchId);
    if (error) throw error;
    return data || [];
  }

  async function dbUpsertMatchStats(matchId, entries){
    const { error: delErr } = await supabaseClient
      .from("match_goalie_stats")
      .delete()
      .eq("match_id", matchId);
    if (delErr) throw delErr;

    const rows = entries.map(e => ({
      match_id: matchId,
      goalie_id: e.goalie_id,
      team_id: CURRENT_TEAM_ID,
      minutes: e.minutes || 0,
      shots:   e.shots   || 0,
      goals:   e.goals   || 0
    }));
    if (!rows.length) return;

    const { error: insErr } = await supabaseClient
      .from("match_goalie_stats")
      .insert(rows);
    if (insErr) throw insErr;
  }

  // ---------- Teams init ----------
  async function initTeams(){
    const sel = $("#team-select");
    sel.innerHTML = "<option>Laddar...</option>";

    try {
      let teams = await dbMyTeams();
      teams = teams.filter((t, i, arr) => arr.findIndex(x => x.id === t.id) === i);

      if (!teams.length) {
        const t = await dbCreateTeam("Mitt Team");
        teams = await dbMyTeams();
        CURRENT_TEAM_ID = t.id;
      }

      if (!CURRENT_TEAM_ID) CURRENT_TEAM_ID = teams[0].id;

      sel.innerHTML = "";
      teams.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        if (t.id === CURRENT_TEAM_ID) opt.selected = true;
        sel.appendChild(opt);
      });

      sel.onchange = async () => {
        CURRENT_TEAM_ID = sel.value;
        try {
          await refreshAll();
        } catch (e) {
          showError("team-switch", e);
        }
      };

      $("#btn-new-team").onclick = async () => {
        const name = prompt("Teamnamn:")?.trim();
        if (!name) return;
        try {
          const t = await dbCreateTeam(name);
          CURRENT_TEAM_ID = t.id;
          await initTeams();
          await refreshAll();
        } catch (e) {
          showError("new-team", e);
        }
      };
    } catch (e) {
      showError("init-teams", e);
    }
  }

  // ---------- Filter ----------
  function getFilterRange(){
    const f = $("#filter-from").value || null;
    const t = $("#filter-to").value   || null;
    return { from: f, to: t };
  }

  function parseHomeAway(opponent){
    const s = String(opponent || "");
    const m = s.match(/\((h|b)\)\s*$/i);
    return m ? m[1].toLowerCase() : "";
  }

  function stripHomeAway(opponent){
    return String(opponent || "").replace(/\s*\((h|b)\)\s*$/i, "").trim();
  }

  function normalizeHomeAwayInput(v){
    const s = String(v || "").trim().toLowerCase();
    if (s === "h" || s === "hemma") return "h";
    if (s === "b" || s === "borta") return "b";
    return "";
  }

  function applyHomeAwayToOpponent(opponent, homeAway){
    const base = stripHomeAway(opponent);
    if (!homeAway) return base;
    return base ? `${base} (${homeAway})` : `(${homeAway})`;
  }

  function periodToDb(value){
    const v = String(value || "").toUpperCase();
    if (v === "OT") return 4;
    const n = parseInt(v, 10);
    if (n === 1 || n === 2 || n === 3) return n;
    return 1;
  }

  function periodLabel(value){
    const v = String(value || "").toUpperCase();
    if (v === "OT" || v === "4") return "OT";
    if (v === "1" || v === "2" || v === "3") return v;
    return "-";
  }

  function periodEquals(filterValue, rowValue){
    const f = String(filterValue || "").toUpperCase();
    if (f === "ALL") return true;
    return periodLabel(rowValue) === f;
  }

  function isOurGoalRightForPeriod(ourGoalRightP1, period){
    const p = periodLabel(period);
    if (p === "2") return !ourGoalRightP1;
    if (p === "OT") return !ourGoalRightP1;
    return ourGoalRightP1; // period 1/3
  }

  function mapShotForDisplay(shot, ourGoalRightP1){
    const x = (shot.x ?? 0.5);
    if (!isOurGoalRightForPeriod(ourGoalRightP1, shot.period)) {
      return { ...shot, x: 1 - x };
    }
    return shot;
  }

  function mapShotXForStorage(xNorm, period, ourGoalRightP1){
    if (!isOurGoalRightForPeriod(ourGoalRightP1, period)) return 1 - xNorm;
    return xNorm;
  }

  // ---------- Shot map / heatmap helpers ----------
  function drawRinkBase(ctx, W, H, pad=0){
    const RW = Math.max(1, W - pad * 2);
    const RH = Math.max(1, H - pad * 2);
    ctx.save();
    ctx.translate(pad, pad);

    const iceGradient = ctx.createLinearGradient(0, 0, RW, RH);
    iceGradient.addColorStop(0, "#f8fafc");
    iceGradient.addColorStop(0.5, "#ffffff");
    iceGradient.addColorStop(1, "#f1f5f9");
    ctx.fillStyle = iceGradient;

    const cornerRadius = RH * 0.18;
    ctx.beginPath();
    if (ctx.roundRect) {
      ctx.roundRect(0, 0, RW, RH, cornerRadius);
    } else {
      ctx.moveTo(cornerRadius, 0);
      ctx.lineTo(RW - cornerRadius, 0);
      ctx.quadraticCurveTo(RW, 0, RW, cornerRadius);
      ctx.lineTo(RW, RH - cornerRadius);
      ctx.quadraticCurveTo(RW, RH, RW - cornerRadius, RH);
      ctx.lineTo(cornerRadius, RH);
      ctx.quadraticCurveTo(0, RH, 0, RH - cornerRadius);
      ctx.lineTo(0, cornerRadius);
      ctx.quadraticCurveTo(0, 0, cornerRadius, 0);
    }
    ctx.fill();

    ctx.strokeStyle = "#cbd5e1";
    ctx.lineWidth = 3;
    ctx.beginPath();
    if (ctx.roundRect) {
      ctx.roundRect(1.5, 1.5, RW - 3, RH - 3, cornerRadius);
    } else {
      ctx.moveTo(cornerRadius, 1.5);
      ctx.lineTo(RW - cornerRadius, 1.5);
      ctx.quadraticCurveTo(RW - 1.5, 1.5, RW - 1.5, cornerRadius);
      ctx.lineTo(RW - 1.5, RH - cornerRadius);
      ctx.quadraticCurveTo(RW - 1.5, RH - 1.5, RW - cornerRadius, RH - 1.5);
      ctx.lineTo(cornerRadius, RH - 1.5);
      ctx.quadraticCurveTo(1.5, RH - 1.5, 1.5, RH - cornerRadius);
      ctx.lineTo(1.5, cornerRadius);
      ctx.quadraticCurveTo(1.5, 1.5, cornerRadius, 1.5);
    }
    ctx.stroke();

    const centerX = RW / 2;
    const centerY = RH / 2;

    const goalLineOffset = RW * 0.06;
    ctx.strokeStyle = "#ef4444";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(goalLineOffset, 6);
    ctx.lineTo(goalLineOffset, RH - 6);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(RW - goalLineOffset, 6);
    ctx.lineTo(RW - goalLineOffset, RH - 6);
    ctx.stroke();

    ctx.strokeStyle = "#3b82f6";
    ctx.lineWidth = 3;
    const BLUE_RATIO = 25 / 60;
    const blue1 = RW * BLUE_RATIO;
    const blue2 = RW * (1 - BLUE_RATIO);
    ctx.beginPath();
    ctx.moveTo(blue1, 0);
    ctx.lineTo(blue1, RH);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(blue2, 0);
    ctx.lineTo(blue2, RH);
    ctx.stroke();

    ctx.strokeStyle = "#ef4444";
    ctx.lineWidth = 3;
    ctx.setLineDash([8, 8]);
    ctx.beginPath();
    ctx.moveTo(centerX, 0);
    ctx.lineTo(centerX, RH);
    ctx.stroke();
    ctx.setLineDash([]);

    const centerCircleRadius = Math.min(RW, RH) * 0.18;
    ctx.strokeStyle = "#60a5fa";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(centerX, centerY, centerCircleRadius, 0, Math.PI * 2);
    ctx.stroke();

    function drawFaceOffCircle(x, y, withCircle){
      const circleRadius = Math.min(RW, RH) * 0.14;
      if (withCircle){
        ctx.strokeStyle = "#ef4444";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(x, y, circleRadius, 0, Math.PI * 2);
        ctx.stroke();

        const hashLength = 8;
        const hashOffset = circleRadius * 0.4;
        ctx.beginPath();
        ctx.moveTo(x - hashOffset, y - circleRadius + 5);
        ctx.lineTo(x - hashOffset, y - circleRadius + 5 + hashLength);
        ctx.moveTo(x + hashOffset, y - circleRadius + 5);
        ctx.lineTo(x + hashOffset, y - circleRadius + 5 + hashLength);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(x - hashOffset, y + circleRadius - 5);
        ctx.lineTo(x - hashOffset, y + circleRadius - 5 - hashLength);
        ctx.moveTo(x + hashOffset, y + circleRadius - 5);
        ctx.lineTo(x + hashOffset, y + circleRadius - 5 - hashLength);
        ctx.stroke();
      }

      ctx.fillStyle = "#ef4444";
      ctx.beginPath();
      ctx.arc(x, y, 4, 0, Math.PI * 2);
      ctx.fill();
    }

    const offX = RW * 0.21;
    const offYTop = RH * 0.24;
    const offYBot = RH * 0.76;
    const nzX = centerX + RW * 0.13;
    drawFaceOffCircle(offX, offYTop, true);
    drawFaceOffCircle(offX, offYBot, true);
    drawFaceOffCircle(RW - offX, offYTop, true);
    drawFaceOffCircle(RW - offX, offYBot, true);
    drawFaceOffCircle(centerX - (nzX - centerX), offYTop, false);
    drawFaceOffCircle(centerX - (nzX - centerX), offYBot, false);
    drawFaceOffCircle(nzX, offYTop, false);
    drawFaceOffCircle(nzX, offYBot, false);

    ctx.fillStyle = "#ef4444";
    ctx.beginPath();
    ctx.arc(centerX, centerY, 4, 0, Math.PI * 2);
    ctx.fill();

    const creaseRadius = RH * 0.08;
    ctx.fillStyle = "rgba(147, 197, 253, 0.5)";
    ctx.strokeStyle = "#60a5fa";
    ctx.lineWidth = 2;
    const leftCreaseCenterX = goalLineOffset + creaseRadius * 0.8;
    ctx.beginPath();
    ctx.arc(leftCreaseCenterX, centerY, creaseRadius, -Math.PI/2, Math.PI/2);
    ctx.lineTo(goalLineOffset, centerY + creaseRadius);
    ctx.lineTo(goalLineOffset, centerY - creaseRadius);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    const rightCreaseCenterX = RW - goalLineOffset - creaseRadius * 0.8;
    ctx.beginPath();
    ctx.arc(rightCreaseCenterX, centerY, creaseRadius, Math.PI/2, -Math.PI/2);
    ctx.lineTo(RW - goalLineOffset, centerY - creaseRadius);
    ctx.lineTo(RW - goalLineOffset, centerY + creaseRadius);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    const netWidth = RW * 0.02;
    const netHeight = RH * 0.18;
    ctx.fillStyle = "rgba(148, 163, 184, 0.8)";
    ctx.strokeStyle = "#64748b";
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.rect(goalLineOffset - netWidth - 3, centerY - netHeight / 2, netWidth, netHeight);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.rect(RW - goalLineOffset + 3, centerY - netHeight / 2, netWidth, netHeight);
    ctx.fill();
    ctx.stroke();

    ctx.restore();
  }

  function drawOurGoalIndicator(ctx, W, H, ourGoalRight=true){
    ctx.save();
    ctx.fillStyle = "rgba(15, 23, 42, 0.75)";
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.textBaseline = "top";
    const text = "Vårt mål →";
    const x = W - 90;
    const y = 10;
    ctx.fillText(text, x, y);
    ctx.restore();
  }

  function renderShotMap(rinkEl, shots, goalieById, filterGoalieId){
    rinkEl.innerHTML = "";
    const w = rinkEl.clientWidth  || 360;
    const h = rinkEl.clientHeight || 180;
    const pad = 8;

    const canvas = document.createElement("canvas");
    canvas.width = w;
    canvas.height = h;
    canvas.style.width = "100%";
    canvas.style.height = "100%";
    canvas.classList.add("rounded-xl");
    rinkEl.appendChild(canvas);

    const ctx = canvas.getContext("2d");
    if (!ctx) return;
    drawRinkBase(ctx, w, h, pad);
    drawOurGoalIndicator(ctx, w, h, true);

    const filtered = shots.filter(s=>{
      if (filterGoalieId && filterGoalieId !== "ALL" && String(s.goalie_id) !== String(filterGoalieId)) return false;
      return true;
    });

    for (const s of filtered){
      const cx = pad + (w-2*pad)*(s.x ?? 0.5);
      const cy = pad + (h-2*pad)*(s.y ?? 0.5);
      let color = "#0f766e";
      const r = String(s.result||"").toLowerCase();
      if (r.startsWith("goal")) color = "#ef4444";
      else if (r.startsWith("miss")) color = "#6b7280";
      else if (r.startsWith("post")) color = "#f97316";

      ctx.beginPath();
      ctx.arc(cx, cy, 4, 0, Math.PI * 2);
      ctx.fillStyle = color;
      ctx.globalAlpha = 0.85;
      ctx.fill();
      ctx.globalAlpha = 1;
    }
  }

  function renderShotLegend(el, shots, filterGoalieId){
    const filtered = shots.filter(s=>{
      if (filterGoalieId && filterGoalieId !== "ALL" && String(s.goalie_id) !== String(filterGoalieId)) return false;
      return true;
    });
    const total = filtered.length;
    const goals = filtered.filter(s=>String(s.result||"").toLowerCase().startsWith("goal")).length;
    const saves = filtered.filter(s=>String(s.result||"").toLowerCase().startsWith("save")).length;
    const miss  = filtered.filter(s=>String(s.result||"").toLowerCase().startsWith("miss")).length;
    const post  = filtered.filter(s=>String(s.result||"").toLowerCase().startsWith("post")).length;

    el.innerHTML = `
      <div class="flex flex-wrap gap-3">
        <div class="flex items-center gap-1 text-xs">
          <span class="inline-block w-3 h-3 rounded-full bg-red-500"></span> Mål: ${goals}
        </div>
        <div class="flex items-center gap-1 text-xs">
          <span class="inline-block w-3 h-3 rounded-full bg-teal-700"></span> Räddn: ${saves}
        </div>
        <div class="flex items-center gap-1 text-xs">
          <span class="inline-block w-3 h-3 rounded-full bg-gray-500"></span> Miss: ${miss}
        </div>
        <div class="flex items-center gap-1 text-xs">
          <span class="inline-block w-3 h-3 rounded-full bg-orange-500"></span> Ribba/Stolpe: ${post}
        </div>
        <div class="text-xs text-slate-500 ml-auto">Totalt: ${total}</div>
      </div>
    `;
  }

  function computeShotXG(W,H,pad,xNorm,yNorm){
    const x = pad + (W-2*pad)*(xNorm ?? 0.5);
    const y = pad + (H-2*pad)*(yNorm ?? 0.5);
    const goalX = W - pad;
    const goalY = H/2;
    const dx = goalX - x;
    const dy = goalY - y;
    const dist = Math.sqrt(dx*dx+dy*dy);
    const dNorm = Math.min(Math.max(dist/300,0),1);
    const base = 0.35;
    const xg = base*(1-dNorm);
    return Math.max(0.01, Math.min(0.6,xg));
  }

  function drawHeatmap(cvs,W,H,pad,shots){
    const ctx = cvs.getContext("2d");
    cvs.width = W; cvs.height = H;
    ctx.clearRect(0,0,W,H);
    const sigma = 28;
    const twoSigmaSq = 2*sigma*sigma;
    const pts = shots.map(s=>({
      x: pad + (W-2*pad)*(s.x ?? 0.5),
      y: pad + (H-2*pad)*(s.y ?? 0.5),
      w: String(s.result||"").toLowerCase().startsWith("goal") ? 1.4 : 1.0
    }));
    const img = ctx.createImageData(W,H);
    const data = img.data;
    for (let y=0;y<H;y++){
      for (let x=0;x<W;x++){
        let val = 0;
        for (const p of pts){
          const dx=x-p.x, dy=y-p.y;
          const d2 = dx*dx+dy*dy;
          const contrib = Math.exp(-d2/twoSigmaSq)*p.w;
          val += contrib;
        }
        const idx = (y*W+x)*4;
        const c = Math.min(val*80,255);
        const a = c < 6 ? 0 : Math.min(200,c+30);
        data[idx+0] = c;
        data[idx+1] = Math.max(0,c-60);
        data[idx+2] = 0;
        data[idx+3] = a;
      }
    }
    ctx.putImageData(img,0,0);
  }

  // ---------- UI: refresh ----------
  function buildStatsByMatch(statsRows){
    const map = new Map();

    for (const r of statsRows){
      const shots = r.shots ?? 0;
      const saves = r.saves ?? 0;
      let goals   = r.goals ?? (shots - saves);
      if (goals < 0) goals = 0;

      const row = {
        match_id : r.match_id,
        goalie_id: r.goalie_id,
        minutes  : r.minutes ?? 0,
        shots,
        saves,
        goals
      };

      if (!map.has(r.match_id)) map.set(r.match_id, []);
      map.get(r.match_id).push(row);
    }

    return map;
  }

  function getStatForGoalieMatch(statsByMatch, matchId, goalieId){
    const arr = statsByMatch.get(matchId) || [];
    return arr.find(r=>r.goalie_id === goalieId) || null;
  }

  async function refreshAll(){
    if (!CURRENT_TEAM_ID) return;
    const {from,to} = getFilterRange();
    try{
      GOALIES = await dbGoalies(CURRENT_TEAM_ID);
      const matches = await dbMatches(CURRENT_TEAM_ID, from, to);
      const matchIds = matches.map(m=>m.id);
      const statsRows = await dbMatchStatsBulk(matchIds);
      const statsByMatch = buildStatsByMatch(statsRows);

      renderGoalies(GOALIES, matches, statsByMatch);
      renderMatches(matches, GOALIES, statsByMatch);
      renderSummaries(matches, GOALIES, statsByMatch);
    } catch(e){
      showError("refreshAll",e);
    }
  }

  function renderSummaries(matches, goalies, statsByMatch){
    const totalMatches = matches.length;
    $("#summary-matches").textContent = fmtInt(totalMatches);

    const v = matches.filter(m=>m.result === "V").length;
    const o = matches.filter(m=>m.result === "O").length;
    const f = matches.filter(m=>m.result === "F").length;
    $("#summary-result").textContent = `${v} / ${o} / ${f}`;

    let totalShots = 0;
    let totalGoals = 0;

    for (const g of goalies){
      for (const m of matches){
        const s = getStatForGoalieMatch(statsByMatch, m.id, g.id);
        if (!s) continue;
        totalShots += s.shots || 0;
        totalGoals += s.goals || 0;
      }
    }
    $("#summary-shots").textContent = fmtInt(totalShots);
    $("#summary-goals").textContent = fmtInt(totalGoals);

    const goalieStats = goalies.map(g=>{
      let sh=0, gl=0;
      for (const m of matches){
        const s = getStatForGoalieMatch(statsByMatch,m.id,g.id);
        if (!s) continue;
        sh += s.shots || 0;
        gl += s.goals || 0;
      }
      return { g, sh, gl };
    }).filter(x=>x.sh>0);

    const svArr = goalieStats.map(x=>(x.sh-x.gl)/x.sh);
    let avg = null;
    if (svArr.length){
      avg = svArr.reduce((a,s)=>a+s,0)/svArr.length;
    }
    $("#summary-svpct").textContent = (avg==null) ? "-"
      : (avg*100).toFixed(1).replace(".",",")+" %";
    $("#summary-goalies").textContent = fmtInt(goalieStats.length);
  }

  function renderGoalies(goalies, matches, statsByMatch){
    const wrap = $("#goalies-wrap");
    const empty = $("#goalies-empty");
    wrap.innerHTML = "";
    if (!goalies.length){
      empty.classList.remove("hidden");
      return;
    }
    empty.classList.add("hidden");

    goalies.forEach(g=>{
      let shots=0, goals=0, minutes=0;
      for (const m of matches){
        const s = getStatForGoalieMatch(statsByMatch, m.id, g.id);
        if (!s) continue;
        shots   += s.shots   || 0;
        goals   += s.goals   || 0;
        minutes += s.minutes || 0;
      }
      const saves = shots-goals;
      const sv = shots>0 ? saves/shots : null;

      const card = document.createElement("div");
      card.className = "bg-white rounded-2xl p-3 shadow-sm";

      const title = document.createElement("div");
      title.className = "flex items-center justify-between mb-2";
      title.innerHTML = `
        <div>
          <div class="text-sm font-semibold">
            ${g.name || "(namn saknas)"}
          </div>
          <div class="text-xs text-slate-500">Kod: ${g.code || "-"}</div>
        </div>
      `;
      card.appendChild(title);

      const rows = document.createElement("div");
      rows.className = "grid grid-cols-4 gap-2 text-xs mt-1";
      rows.innerHTML = `
        <div class="rounded-xl border p-2">
          <div class="text-[11px] text-slate-500">Matcher</div>
          <div class="font-semibold">${matches.filter(m =>
            getStatForGoalieMatch(statsByMatch,m.id,g.id)
          ).length}</div>
        </div>
        <div class="rounded-xl border p-2">
          <div class="text-[11px] text-slate-500">Räddnings-%</div>
          <div class="font-semibold">${fmtPct(sv)}</div>
        </div>
        <div class="rounded-xl border p-2">
          <div class="text-[11px] text-slate-500">Skott</div>
          <div class="font-semibold">${fmtInt(shots)}</div>
        </div>
        <div class="rounded-xl border p-2">
          <div class="text-[11px] text-slate-500">Minuter</div>
          <div class="font-semibold">${fmtInt(minutes)}</div>
        </div>
      `;
      card.appendChild(rows);

      const footer = document.createElement("div");
      footer.className = "mt-3 flex justify-end";
      footer.innerHTML = `
        <a href="goalie.html?team=${encodeURIComponent(CURRENT_TEAM_ID)}&code=${encodeURIComponent(g.code)}"
           class="px-3 py-1 rounded-xl border text-sm hover:bg-gray-50">
          Detaljer
        </a>
      `;
      card.appendChild(footer);

      wrap.appendChild(card);
    });
  }

  function renderMatches(matches, goalies, statsByMatch){
    const wrap  = $("#matches-wrap");
    const empty = $("#matches-empty");
    wrap.innerHTML = "";
    window.__match_map = new Map(matches.map(m=>[m.id, m]));
    if (!matches.length){
      empty.classList.remove("hidden");
      return;
    }
    empty.classList.add("hidden");

    matches.forEach(m=>{
      const card = document.createElement("div");
      card.className = "bg-white rounded-2xl p-3 shadow-sm";

      const hdr = `
        <div class="flex items-center justify-between mb-1">
          <div>
            <div class="text-sm font-semibold">
              ${fmtDate(m.date)} - ${m.opponent || "Motståndare?"}
            </div>
            <div class="text-xs text-slate-500">
              Resultat: ${m.our_goals ?? "-"} - ${m.their_goals ?? "-"}
              ${m.result ? "(" + m.result + ")" : ""}
            </div>
          </div>
          <div class="flex items-center gap-2 text-xs">
            <button class="underline" data-edit="${m.id}">Redigera</button>
            <button class="underline text-red-600" data-del="${m.id}">Ta bort</button>
          </div>
        </div>
      `;

      const rows = [];
      for (const g of goalies){
        const s = getStatForGoalieMatch(statsByMatch, m.id, g.id) || {};
        const shots = s.shots || 0;
        const goals = s.goals || 0;
        const saves = shots - goals;
        const sv = shots>0 ? saves/shots : null;
        const min = s.minutes || 0;
        rows.push({
          g, shots, goals, saves, sv, min
        });
      }

      const rowsHtml = rows.map(r => `
        <div class="grid grid-cols-12 gap-1 text-xs py-1 border-b last:border-b-0">
          <div class="col-span-6">${r.g.name || r.g.code || "(målvakt)"}</div>
          <div class="col-span-2 text-center">${fmtTimeMin(r.min)}</div>
          <div class="col-span-2 text-center">${fmtPct(r.sv)}</div>
          <div class="col-span-2 text-center">${fmtInt(r.shots)}</div>
        </div>
      `).join("");

      card.innerHTML = hdr + `
        <div class="grid grid-cols-12 text-xs text-gray-500 border-b pb-1 mb-1">
          <div class="col-span-6">Målvakt</div>
          <div class="col-span-2 text-center">Min</div>
          <div class="col-span-2 text-center">Räddn</div>
          <div class="col-span-2 text-center">Skott</div>
        </div>
        ${rowsHtml}
        <div class="mt-2 text-[11px] text-gray-500">
          "Skott" = räddningar + mål. Miss/block visas inte här.
        </div>
        <div class="mt-3 flex items-center justify-between">
          <button class="text-sm underline" data-shots-toggle="${m.id}">
            Visa skottkarta
          </button>
        </div>
        <div id="shots-wrap-${m.id}" class="hidden mt-2">
          <div class="flex items-center gap-2 mb-2">
            <label class="flex items-center gap-1 text-xs">
              <input type="checkbox" data-heatmap="${m.id}">
              Heatmap
            </label>
            <span class="text-xs">xG: <b id="xg-${m.id}">-</b></span>
            <label class="text-xs">Målvakt:</label>
            <select id="shots-filter-${m.id}"
                    class="border rounded px-2 py-1 text-sm"></select>
            <label class="text-xs">Period:</label>
            <select id="shots-period-${m.id}"
                    class="border rounded px-2 py-1 text-sm">
              <option value="ALL">Alla</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="OT">OT</option>
            </select>
          </div>
          <div class="relative w-full aspect-[2/1]">
            <div id="rink-${m.id}"
                 class="w-full h-full rounded-xl border bg-white"></div>
            <canvas id="heat-${m.id}"
                    class="absolute inset-0 w-full h-full pointer-events-none hidden"></canvas>
          </div>
          <div id="legend-${m.id}"
               class="mt-2 text-xs text-gray-600"></div>
        </div>
      `;
      wrap.appendChild(card);
    });

    // Skottkarta + handlers (once)
    if (!wrap.__hasShotsHandler__){
      wrap.addEventListener("click", async (e)=>{
        const btn = e.target.closest("[data-shots-toggle]");
        if (!btn) return;
        const matchId = btn.dataset.shotsToggle;
        const panel   = document.getElementById("shots-wrap-"+matchId);
        if (!panel) return;
        panel.classList.toggle("hidden");
        if (panel.classList.contains("hidden")) return;

        const rinkEl   = document.getElementById("rink-"+matchId);
        const selEl    = document.getElementById("shots-filter-"+matchId);
        const perEl    = document.getElementById("shots-period-"+matchId);
        const legendEl = document.getElementById("legend-"+matchId);
        if (!rinkEl || !selEl || !legendEl || !perEl) return;

        window.__shots_cache = window.__shots_cache || new Map();
        let shots = __shots_cache.get(matchId);
        if (!shots){
          try{
            shots = await dbLoadShotsForMatch(matchId);
            __shots_cache.set(matchId, shots);
          } catch(err){
            showError("load-shots-match",err);
            return;
          }
        }

        const gids = [...new Set(shots.map(s=>s.goalie_id))];
        const goalieById = new Map((GOALIES||[]).map(g=>[g.id,g]));
        selEl.innerHTML = `<option value="ALL">Alla målvakter</option>`
          + gids.map(gid=>{
              const g = goalieById.get(gid);
              const label = g ? `${g.name} (${g.code})` : "Okänd målvakt";
              return `<option value="${gid}">${label}</option>`;
            }).join("");

        const draw = () => {
          const match = window.__match_map?.get(matchId);
          const ourRightP1 = (match?.our_goal_right_p1 ?? true);
          const filter = selEl.value || "ALL";
          const period = perEl.value || "ALL";
          const periodFiltered = shots.filter(s => periodEquals(period, s.period));
          const filtered = periodFiltered.filter(s =>
            filter === "ALL" || String(s.goalie_id) === String(filter)
          );
          const mapped = filtered.map(s => mapShotForDisplay(s, ourRightP1));
          renderShotMap(rinkEl, mapped, goalieById, filter);
          renderShotLegend(legendEl, filtered, filter);
          const W = rinkEl.clientWidth || 360;
          const H = rinkEl.clientHeight || Math.round(W*0.6);
          const pad = 8;
          const xgSum = mapped
            .filter(s=>{
              const r = String(s.result||"").toLowerCase();
              return r.startsWith("goal") || r.startsWith("save");
            })
            .reduce((a,s)=>a+computeShotXG(W,H,pad,s.x,s.y),0);
          const xgEl = document.getElementById("xg-"+matchId);
          if (xgEl) xgEl.textContent = xgSum.toFixed(2);

          const chk = document.querySelector('[data-heatmap="'+matchId+'"]');
          const cvs = document.getElementById("heat-"+matchId);
          if (chk && cvs){
            cvs.classList.toggle("hidden", !chk.checked);
            if (chk.checked) drawHeatmap(cvs,W,H,pad,mapped);
          }
        };

        selEl.onchange = draw;
        perEl.onchange = draw;
        const heatChk = document.querySelector('[data-heatmap="'+matchId+'"]');
        if (heatChk) heatChk.onchange = draw;
        draw();
      });
      wrap.__hasShotsHandler__ = true;
    }

    // Delete handler
    if (!wrap.__hasDeleteHandler__){
      wrap.addEventListener("click", async (e)=>{
        const a = e.target.closest("[data-del]");
        if (!a) return;
        e.preventDefault();
        const matchId = a.dataset.del;
        if (!matchId) return;
        if (!confirm("Ta bort den här matchen?")) return;
        try{
          await dbDeleteMatch(matchId);
          await refreshAll();
        } catch(err){
          showError("delete-match",err);
        }
      });
      wrap.__hasDeleteHandler__ = true;
    }

    // Edit handler
    if (!wrap.__hasEditHandler__){
      wrap.addEventListener("click", async (e)=>{
        const btn = e.target.closest("[data-edit]");
        if (!btn) return;
        const matchId = btn.dataset.edit;
        if (!matchId) return;
        try{
          await openEditModal(matchId);
        } catch(err){
          showError("open-edit",err);
        }
      });
      wrap.__hasEditHandler__ = true;
    }
  }

  // ---------- Ny målvakt / ny match ----------
  async function createNewGoalie(){
    if (!CURRENT_TEAM_ID) return;
    const code = prompt("Målvaktskod (t.ex. #30):")?.trim();
    if (!code) return;
    const name = prompt("Namn (valfritt):")?.trim() || "";
    try{
      await dbCreateGoalie(CURRENT_TEAM_ID, code, name);
      await refreshAll();
    } catch(e){ showError("create-goalie",e); }
  }

  async function createNewMatch(){
    if (!CURRENT_TEAM_ID) return;
    const d = prompt("Datum (YYYY-MM-DD):", new Date().toISOString().slice(0,10))?.trim();
    if (!d) return;
    const opp = prompt("Motståndare:")?.trim() || "";
    const haIn = prompt("Hemma eller borta? (h/b):", "h")?.trim() || "";
    const homeAway = normalizeHomeAwayInput(haIn);
    const rightIn = prompt("Vårt mål är till höger i period 1? (ja/nej):", "ja")?.trim() || "ja";
    const ourGoalRightP1 = !/^n(ej)?$/i.test(rightIn);
    const ourG   = Number(prompt("Vära mål:", "0")   || "0");
    const theirG = Number(prompt("Deras mål:", "0")  || "0");
    let result = "";
    if (!Number.isNaN(ourG) && !Number.isNaN(theirG)){
      if (ourG > theirG) result = "V";
      else if (ourG < theirG) result = "F";
      else result = "O";
    }
    try{
      await dbCreateMatch(CURRENT_TEAM_ID,{
        date: d, opponent: applyHomeAwayToOpponent(opp, homeAway),
        our_goal_right_p1: ourGoalRightP1,
        our_goals: ourG, their_goals: theirG, result
      });
      await refreshAll();
    } catch(e){ showError("create-match",e); }
  }

  // ---------- Edit-modal ----------
  let EDIT_MATCH_ID = null;
  let EDIT_ENTRIES  = [];
  let EDIT_SHOT_BUF = {};

  async function openEditModal(matchId){
    EDIT_MATCH_ID = matchId;
    const { data: match, error } = await supabaseClient
      .from("matches")
      .select("*")
      .eq("id",matchId)
      .single();
    if (error) throw error;

    const statsRows = await dbMatchStatsForMatch(matchId);

    EDIT_ENTRIES = GOALIES.map(g=>{
      const s = statsRows.find(r=>r.goalie_id === g.id) || {};
      return {
        goalie_id: g.id,
        name: g.name || g.code || "(målvakt)",
        code: g.code || "",
        minutes: s.minutes || 0,
        shots:   s.shots   || 0,
        goals:   s.goals   || 0
      };
    });

    const body = $("#edit-body");
    body.innerHTML = "";

    const existingHA = parseHomeAway(match.opponent);
    const existingOpp = stripHomeAway(match.opponent);
    const existingOurRightP1 = (match.our_goal_right_p1 ?? true);

    const meta = document.createElement("div");
    meta.className = "mb-3 text-sm";
    meta.innerHTML = `
      <div class="flex gap-2">
        <div class="flex-1">
          <label class="block text-xs text-gray-500 mb-1">Datum</label>
          <input id="edit-date" type="date"
                 class="border rounded px-2 py-1 w-full text-sm"
                 value="${match.date || ""}">
        </div>
        <div class="flex-1">
          <label class="block text-xs text-gray-500 mb-1">Motståndare</label>
          <input id="edit-opp" type="text"
                 class="border rounded px-2 py-1 w-full text-sm"
                 value="${existingOpp}">
        </div>
        <div class="w-28">
          <label class="block text-xs text-gray-500 mb-1">Hemma/borta</label>
          <select id="edit-homeaway" class="border rounded px-2 py-1 w-full text-sm">
            <option value="" ${existingHA ? "" : "selected"}>?</option>
            <option value="h" ${existingHA === "h" ? "selected" : ""}>Hemma</option>
            <option value="b" ${existingHA === "b" ? "selected" : ""}>Borta</option>
          </select>
        </div>
      </div>
      <div class="flex gap-2 mt-2">
        <div class="flex-1">
          <label class="block text-xs text-gray-500 mb-1">Vårt mål höger i P1</label>
          <select id="edit-ourgoal" class="border rounded px-2 py-1 w-full text-sm">
            <option value="true" ${existingOurRightP1 ? "selected" : ""}>Ja</option>
            <option value="false" ${!existingOurRightP1 ? "selected" : ""}>Nej</option>
          </select>
        </div>
      </div>
      <div class="flex gap-2 mt-2">
        <div class="flex-1">
          <label class="block text-xs text-gray-500 mb-1">Vära mål</label>
          <input id="edit-our" type="number"
                 class="border rounded px-2 py-1 w-full text-sm"
                 value="${match.our_goals ?? ""}">
        </div>
        <div class="flex-1">
          <label class="block text-xs text-gray-500 mb-1">Deras mål</label>
          <input id="edit-their" type="number"
                 class="border rounded px-2 py-1 w-full text-sm"
                 value="${match.their_goals ?? ""}">
        </div>
      </div>
    `;
    body.appendChild(meta);

    const tbl = document.createElement("div");
    tbl.className = "mt-3 border-t pt-2";
    tbl.innerHTML = `
      <div class="grid grid-cols-5 gap-1 text-xs text-gray-500 mb-1">
        <div>Målvakt</div>
        <div class="text-center">Min</div>
        <div class="text-center">Skott</div>
        <div class="text-center">Mål</div>
        <div class="text-center">Rädd%</div>
      </div>
    `;
    EDIT_ENTRIES.forEach((e,idx)=>{
      const row = document.createElement("div");
      row.className = "grid grid-cols-5 gap-1 items-center mb-1 text-xs";
      row.innerHTML = `
        <div>${e.name}</div>
        <div>
          <input type="number" step="0.1"
                 class="border rounded px-1 py-0.5 w-full text-xs"
                 data-field="minutes" data-idx="${idx}"
                 value="${e.minutes}">
        </div>
        <div>
          <input type="number"
                 class="border rounded px-1 py-0.5 w-full text-xs"
                 data-field="shots" data-idx="${idx}"
                 value="${e.shots}">
        </div>
        <div>
          <input type="number"
                 class="border rounded px-1 py-0.5 w-full text-xs"
                 data-field="goals" data-idx="${idx}"
                 value="${e.goals}">
        </div>
        <div class="text-center" data-field="sv-${idx}"></div>
      `;
      tbl.appendChild(row);
    });
    body.appendChild(tbl);

    function recalc(){
      EDIT_ENTRIES.forEach((e,idx)=>{
        const s = e.shots || 0;
        const g = e.goals || 0;
        const el = body.querySelector(`[data-field="sv-${idx}"]`);
        if (!el) return;
        if (s>0){
          const sv = (s-g)/s;
          el.textContent = fmtPct(sv);
        }else{
          el.textContent = "-";
        }
      });
    }
    recalc();

    body.addEventListener("input", e=>{
      const inp   = e.target;
      const field = inp.dataset.field;
      const idx   = Number(inp.dataset.idx);
      if (!field || Number.isNaN(idx)) return;
      let v = parseFloat(inp.value);
      if (Number.isNaN(v)) v = 0;
      EDIT_ENTRIES[idx][field] = v;
      recalc();
    });

    EDIT_SHOT_BUF = {};
    const shotBtn = document.createElement("div");
    shotBtn.className = "mt-3";
    shotBtn.innerHTML = `
      <button type="button"
              class="px-3 py-1.5 text-xs rounded-xl border hover:bg-slate-50"
              data-editshots="${matchId}">
        Lägg / redigera skott (skottkarta)
      </button>
      <div class="text-[11px] text-gray-500 mt-1">
        Skottkartan visas i matchlistan. Här kan du lägga till och ta bort skott.
      </div>
    `;
    body.appendChild(shotBtn);

    body.querySelectorAll("[data-editshots]").forEach(btn=>{
      btn.onclick = ()=>openEditShots(btn.dataset.editshots);
    });

    const mm = $("#edit-modal");
    mm.classList.remove("hidden");
    mm.classList.add("flex");
  }

  function closeEditModal(){
    const mm = $("#edit-modal");
    mm.classList.add("hidden");
    mm.classList.remove("flex");
    EDIT_MATCH_ID = null;
    EDIT_ENTRIES  = [];
    EDIT_SHOT_BUF = {};
  }

  async function saveEditModal(){
    if (!EDIT_MATCH_ID) return;
    try{
      const date  = $("#edit-date").value || null;
      const opp   = $("#edit-opp").value || "";
      const haSel = $("#edit-homeaway")?.value || "";
      const homeAway = normalizeHomeAwayInput(haSel);
      const ourGoalRightP1 = ($("#edit-ourgoal")?.value ?? "true") === "true";
      const our   = parseInt($("#edit-our").value  || "0",10);
      const their = parseInt($("#edit-their").value|| "0",10);
      let result = "";
      if (!Number.isNaN(our) && !Number.isNaN(their)){
        if (our>their) result="V";
        else if (our<their) result="F";
        else result="O";
      }

      await dbUpdateMatch(EDIT_MATCH_ID,{
        date, opponent: applyHomeAwayToOpponent(opp, homeAway),
        our_goal_right_p1: ourGoalRightP1,
        our_goals: our, their_goals: their, result
      });

      await dbUpsertMatchStats(EDIT_MATCH_ID, EDIT_ENTRIES);

      closeEditModal();
      await refreshAll();
    } catch(e){
      showError("save-edit",e);
    }
  }

  // ---------- Shot modal (enkel) ----------
  let CURRENT_SHOT_MATCH  = null;
  let CURRENT_SHOT_GOALIE = null;

  function openShotModal(matchId, goalieId, goalieCode){
    CURRENT_SHOT_MATCH  = matchId;
    CURRENT_SHOT_GOALIE = goalieId;
    $("#shot-modal-code").textContent = goalieCode || "";
    $("#shot-result").value = "save";
    $("#shot-period").value = "1";
    $("#shot-time").value = "";
    $("#shot-dots").innerHTML = "";
    const mm = $("#shot-modal");
    mm.classList.remove("hidden");
    mm.classList.add("flex");
  }

  function closeShotModal(){
    const mm = $("#shot-modal");
    mm.classList.add("hidden");
    mm.classList.remove("flex");
    CURRENT_SHOT_MATCH  = null;
    CURRENT_SHOT_GOALIE = null;
  }

  async function saveShot(){
    if (!CURRENT_SHOT_MATCH || !CURRENT_SHOT_GOALIE) return;
    const res  = $("#shot-result").value;
    const per  = $("#shot-period").value;
    const time = $("#shot-time").value.trim();
    const dots = $("#shot-dots").querySelectorAll("div[data-x][data-y]");
    if (!dots.length){
      alert("Klicka på rinken för att lägga skottposition.");
      return;
    }
    const last = dots[dots.length-1];
    const x = parseFloat(last.dataset.x);
    const y = parseFloat(last.dataset.y);
    try{
      await dbAddShot({
        match_id: CURRENT_SHOT_MATCH,
        goalie_id: CURRENT_SHOT_GOALIE,
        result: res,
        period: periodToDb(per),
        time, x, y
      });
      closeShotModal();
      window.__shots_cache && window.__shots_cache.delete(CURRENT_SHOT_MATCH);
    } catch(e){
      showError("save-shot",e);
    }
  }

  function initShotRink(){
    const rink = $("#shot-rink");
    rink.addEventListener("click", e=>{
      const rect = rink.getBoundingClientRect();
      const x = (e.clientX - rect.left)/rect.width;
      const y = (e.clientY - rect.top)/rect.height;
      const dots = $("#shot-dots");
      const d = document.createElement("div");
      d.dataset.x = x.toFixed(4);
      d.dataset.y = y.toFixed(4);
      d.className = "absolute w-3 h-3 rounded-full bg-red-500 -translate-x-1.5 -translate-y-1.5";
      d.style.left = (x*100)+"%";
      d.style.top  = (y*100)+"%";
      dots.appendChild(d);
    });
  }

  // ---------- Skott-editor (avancerad) ----------
  let SHOT_EDITOR_MATCH_ID = null;
  let SHOT_EDITOR_SHOTS = [];
  let SHOT_EDITOR_OUR_RIGHT_P1 = true;

    function renderShotEditor(){
  const canvas = $("#shot-editor-canvas");
  if (!canvas) return;

  const rect = canvas.getBoundingClientRect();
  const W = rect.width || 800;
  const H = rect.height || 400;
  canvas.width = W;
  canvas.height = H;
  const ctx = canvas.getContext("2d");
  if (!ctx) return;
  const mappedShots = SHOT_EDITOR_SHOTS.map(s => mapShotForDisplay(s, SHOT_EDITOR_OUR_RIGHT_P1));

  // ----- BAKGRUND / RINK -----
  ctx.clearRect(0, 0, W, H);
  drawRinkBase(ctx, W, H, 0);
  drawOurGoalIndicator(ctx, W, H, true);

  // ----- HEATMAP (overlay) -----
  if (mappedShots.length){
    const sigma = 28;
    const twoSigmaSq = 2 * sigma * sigma;
    const pts = mappedShots.map(s => ({
      x: (s.x ?? 0.5) * W,
      y: (s.y ?? 0.5) * H,
      w: String(s.result).toLowerCase() === "goal" ? 1.4 : 1.0
    }));

    const off = document.createElement("canvas");
    off.width = W; off.height = H;
    const offCtx = off.getContext("2d");
    if (offCtx){
      const imageData = offCtx.createImageData(W, H);
      const data = imageData.data;

      for (let y = 0; y < H; y++){
        for (let x = 0; x < W; x++){
          let val = 0;
          for (const p of pts){
            const dx = x - p.x;
            const dy = y - p.y;
            const d2 = dx*dx + dy*dy;
            val += Math.exp(-d2 / twoSigmaSq) * p.w;
          }
          const idx = (y * W + x) * 4;
          const c = Math.min(val * 100, 255);
          const a = c < 6 ? 0 : Math.min(200, c + 30);
          data[idx + 0] = c;
          data[idx + 1] = Math.max(0, c - 80);
          data[idx + 2] = 0;
          data[idx + 3] = a;
        }
      }
      offCtx.putImageData(imageData, 0, 0);
      ctx.save();
      ctx.globalAlpha = 0.45;
      ctx.drawImage(off, 0, 0);
      ctx.restore();
    }
  }

  // ----- SKOTT MED GLOW -----
  const colorMap = {
    goal: "#ef4444",
    save: "#10b981",
    miss: "#6b7280",
    post: "#f59e0b"
  };
  const glowMap = {
    goal: "rgba(239, 68, 68, 0.35)",
    save: "rgba(16, 185, 129, 0.35)",
    miss: "rgba(107, 114, 128, 0.30)",
    post: "rgba(245, 158, 11, 0.35)"
  };

  mappedShots.forEach(s => {
    const cx = (s.x ?? 0.5) * W;
    const cy = (s.y ?? 0.5) * H;
    const key = String(s.result || "").toLowerCase();
    const color = colorMap[key] || colorMap.save;
    const glow = glowMap[key] || glowMap.save;

    ctx.beginPath();
    ctx.arc(cx, cy, 8, 0, Math.PI * 2);
    ctx.fillStyle = glow;
    ctx.fill();

    ctx.beginPath();
    ctx.arc(cx, cy, 5, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();
  });

  // ----- LISTA MED SKOTT (samma som tidigare) -----
  const tbody = $("#shot-editor-list");
  if (tbody){
    const goalieById = new Map(GOALIES.map(g => [String(g.id), g]));

    if (!SHOT_EDITOR_SHOTS.length){
      tbody.innerHTML =
        `<tr><td colspan="6" class="px-2 py-2 text-center text-gray-400">Inga skott ännu.</td></tr>`;
    } else {
      tbody.innerHTML = SHOT_EDITOR_SHOTS.map((s, idx) => {
        const g = goalieById.get(String(s.goalie_id));
        const gName = g ? (g.name || g.code || "Målvakt") : "Målvakt";
        return `
          <tr class="border-b last:border-b-0">
            <td class="px-2 py-1">${gName}</td>
            <td class="px-2 py-1">${s.result}</td>
            <td class="px-2 py-1">${periodLabel(s.period)}</td>
            <td class="px-2 py-1">${(s.x ?? 0).toFixed(3)}</td>
            <td class="px-2 py-1">${(s.y ?? 0).toFixed(3)}</td>
            <td class="px-2 py-1 text-right">
              <button type="button" data-del-idx="${idx}" class="text-red-600 hover:underline">
                Ta bort
              </button>
            </td>
          </tr>
        `;
      }).join("");
    }
  }
}



  async function openEditShots(matchId){
    try{
      SHOT_EDITOR_MATCH_ID = matchId;
      SHOT_EDITOR_SHOTS = await dbLoadShotsForMatch(matchId);
      const mm = window.__match_map?.get(matchId);
      SHOT_EDITOR_OUR_RIGHT_P1 = (mm?.our_goal_right_p1 ?? true);

      // fyll målvaktslista
      const sel = $("#shot-editor-goalie");
      if (GOALIES.length){
        sel.innerHTML = GOALIES.map(g =>
          `<option value="${g.id}">${g.name || g.code || "Målvakt"}</option>`
        ).join("");
      } else {
        sel.innerHTML = `<option value="">Inga målvakter</option>`;
      }

      const modal = $("#shot-editor-modal");
      modal.classList.remove("hidden");

      renderShotEditor();
    } catch(e){
      showError("open-edit-shots", e);
    }
  }

  function closeShotEditor(){
    const modal = $("#shot-editor-modal");
    modal.classList.add("hidden");
    SHOT_EDITOR_MATCH_ID = null;
    SHOT_EDITOR_SHOTS = [];
    SHOT_EDITOR_OUR_RIGHT_P1 = true;
  }

  function handleShotEditorCanvasClick(e){
    if (!SHOT_EDITOR_MATCH_ID) return;
    const canvas = $("#shot-editor-canvas");
    const rect = canvas.getBoundingClientRect();
    const xNorm = (e.clientX - rect.left)/rect.width;
    const yNorm = (e.clientY - rect.top)/rect.height;

    const sel = $("#shot-editor-goalie");
    if (!sel || !sel.value){
      alert("Välj målvakt först.");
      return;
    }
    const goalieId = sel.value;
    const resRadio = document.querySelector('input[name="shot-result"]:checked');
    const result = resRadio ? resRadio.value : "goal";
    const perSel = $("#shot-editor-period");
    const period = perSel ? perSel.value : "1";
    const periodDb = periodToDb(period);
          const xStore = mapShotXForStorage(xNorm, periodLabel(periodDb), SHOT_EDITOR_OUR_RIGHT_P1);

    SHOT_EDITOR_SHOTS.push({
      match_id: SHOT_EDITOR_MATCH_ID,
      team_id: CURRENT_TEAM_ID,
      goalie_id: goalieId,
      result,
      period: periodDb,
      time: null,
      x: xStore,
      y: yNorm
    });

    renderShotEditor();
  }

  function handleShotEditorListClick(e){
    const btn = e.target.closest("[data-del-idx]");
    if (!btn) return;
    const idx = parseInt(btn.dataset.delIdx,10);
    if (Number.isNaN(idx)) return;
    SHOT_EDITOR_SHOTS.splice(idx,1);
    renderShotEditor();
  }

  async function saveShotEditor(){
    if (!SHOT_EDITOR_MATCH_ID) return;
    try{
      await dbReplaceShotsForMatch(SHOT_EDITOR_MATCH_ID, SHOT_EDITOR_SHOTS);
      window.__shots_cache && window.__shots_cache.delete(SHOT_EDITOR_MATCH_ID);
      closeShotEditor();
    } catch(e){
      showError("save-shot-editor", e);
    }
  }

  // ---------- Import / Export ----------
  async function exportJSON(){
    if (!CURRENT_TEAM_ID){
      alert("Du måste ha ett lag valt.");
      return;
    }
    try{
      const goalies = await dbGoalies(CURRENT_TEAM_ID);
      const matches = await dbMatches(CURRENT_TEAM_ID);
      const shotRows = [];
      for (const m of matches){
        const s = await dbLoadShotsForMatch(m.id);
        shotRows.push(...s);
      }
      const matchIds = matches.map(m=>m.id);
      const statsRows = await dbMatchStatsBulk(matchIds);

      const blob = new Blob([JSON.stringify({
        team_id: CURRENT_TEAM_ID,
        goalies, matches, shots: shotRows, match_goalie_stats: statsRows
      }, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "mv_export.json";
      a.click();
      URL.revokeObjectURL(url);
    } catch(e){
      showError("export-json", e);
    }
  }

  // Just nu gär vi såkra, läs-bara imports (loggar bara datan).
  function handleImportJSON(evt){
    const file = evt.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const data = JSON.parse(reader.result);
        console.log("JSON import (endast logg i den här versionen):", data);
        alert("JSON läst in och loggad i konsolen, men import till databasen är inte aktiverad ännu.");
      } catch(e){
        showError("import-json", e);
      } finally {
        evt.target.value = "";
      }
    };
    reader.readAsText(file, "utf-8");
  }

  function handleImportCSV(evt){
    const file = evt.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      console.log("CSV import (endast logg i den här versionen):", reader.result);
      alert("CSV läst in och loggad i konsolen, men import till databasen är inte aktiverad ännu.");
      evt.target.value = "";
    };
    reader.readAsText(file, "utf-8");
  }

  // ---------- Tabs ----------
  function initTabs(){
    const buttons = $$(".tab-btn");
    const panes   = $$(".tab-pane");
    buttons.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const target = btn.dataset.tab;
        buttons.forEach(b=>{
          if (b === btn){
            b.classList.add("border-b-2","border-sky-500","text-sky-600");
            b.classList.remove("text-slate-500");
          } else {
            b.classList.remove("border-b-2","border-sky-500","text-sky-600");
            b.classList.add("text-slate-500");
          }
        });
        panes.forEach(p=>{
          if (p.id === target) p.classList.remove("hidden");
          else p.classList.add("hidden");
        });
      });
    });
  }

  // ---------- Init ----------
  window.addEventListener("DOMContentLoaded", async () => {
    // auth
    $("#btn-auth").onclick = openAuthModal;
    $("#auth-signin").onclick = ()=>handleAuth("signin");
    $("#auth-signup").onclick = ()=>handleAuth("signup");

    // målvakter & matcher
    $("#btn-new-goalie").onclick = createNewGoalie;
    $("#btn-new-match").onclick  = createNewMatch;

    // edit modal
    $("#edit-save").onclick = saveEditModal;

    // shot modal
    initShotRink();
    $("#shot-save").onclick = saveShot;

    // shot editor
    $("#shot-editor-close").onclick  = closeShotEditor;
    $("#shot-editor-cancel").onclick = closeShotEditor;
    $("#shot-editor-save").onclick   = saveShotEditor;
    const seCanvas = $("#shot-editor-canvas");
    if (seCanvas) seCanvas.addEventListener("click", handleShotEditorCanvasClick);
    const seList = $("#shot-editor-list");
    if (seList) seList.addEventListener("click", handleShotEditorListClick);

    // filter
    $("#btn-clear-filter").onclick = () => {
      $("#filter-from").value = "";
      $("#filter-to").value   = "";
      refreshAll();
    };
    $("#filter-from").onchange = refreshAll;
    $("#filter-to").onchange   = refreshAll;

    // import/export
    $("#btn-export-json").onclick = exportJSON;
    $("#imp-json").addEventListener("change", handleImportJSON);
    $("#imp-csv").addEventListener("change", handleImportCSV);

    // tabs
    initTabs();

    // user, teams, data
    await refreshUser();
    await initTeams();
    await refreshAll();
  });
</script>
</body>
</html>
