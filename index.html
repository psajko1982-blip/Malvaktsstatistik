<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>MV – Målvaktsstatistik (RLS + Login)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
  </style>
</head>
<body class="bg-gray-50">
  <div class="mx-auto max-w-screen-sm p-3 sm:p-4">
    <div class="sticky top-0 z-10 -mx-3 -mt-3 mb-3 bg-white/80 backdrop-blur p-3 border-b">
      <h1 class="text-xl font-bold">MV – Målvaktsstatistik</h1>
      <p class="text-sm text-gray-600">Supabase • RLS • E-postinloggning</p>
    </div>

    <!-- Auth -->
    <div id="auth" class="rounded-2xl border bg-white p-4 shadow-sm">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">Logga in</h2>
        <button id="btn-signout" class="text-sm underline hidden">Logga ut</button>
      </div>
      <div id="auth-forms">
        <div class="grid gap-2 sm:grid-cols-2">
          <input id="email" type="email" placeholder="E-post" class="rounded-xl border p-2">
          <input id="password" type="password" placeholder="Lösenord" class="rounded-xl border p-2">
        </div>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <button id="btn-signin" class="rounded-xl border py-2">Logga in</button>
          <button id="btn-signup" class="rounded-xl border py-2">Skapa konto</button>
        </div>
        <div id="auth-msg" class="text-sm text-red-600 mt-2"></div>
      </div>
      <div id="whoami" class="text-sm text-gray-600 mt-2 hidden"></div>
    </div>

    <!-- App UI -->
    <div id="app" class="hidden">
      <!-- Snabb inmatning -->
      <div class="rounded-2xl border shadow-sm p-3 mb-4 bg-white">
        <div class="flex gap-2">
          <div class="flex-1">
            <label class="text-xs text-gray-500">Datum</label>
            <input id="f-date" type="date" class="w-full rounded-xl border p-2">
          </div>
          <div class="flex-1">
            <label class="text-xs text-gray-500">Motstånd</label>
            <input id="f-opp" type="text" placeholder="t.ex. Kumla" class="w-full rounded-xl border p-2">
          </div>
        </div>

        <div class="mt-2">
          <label class="text-xs text-gray-500">Resultat</label>
          <div class="grid grid-cols-3 gap-2 mt-1">
            <button data-res="V" class="resbtn rounded-xl border py-2 text-sm">Vinst</button>
            <button data-res="O" class="resbtn rounded-xl border py-2 text-sm">Oavgjort</button>
            <button data-res="F" class="resbtn rounded-xl border py-2 text-sm">Förlust</button>
          </div>
        </div>

        <div class="mt-3">
          <div class="flex items-center justify-between mb-1">
            <label class="text-xs text-gray-500">Målvakter (min / räddningar / skott)</label>
            <div class="flex gap-2">
              <button id="btn-add-goalie" class="text-xs underline">Lägg till målvakt</button>
              <button id="reset-entries" class="text-xs underline">Nollställ</button>
            </div>
          </div>
          <div id="goalie-grid" class="space-y-2"></div>
        </div>

        <button id="add-match" class="mt-3 w-full rounded-2xl bg-black text-white py-3 font-medium">Lägg till match</button>
        <div id="app-msg" class="text-sm text-red-600 mt-2"></div>
      </div>

      <!-- Översikt -->
      <div id="cards" class="grid sm:grid-cols-2 gap-3 mb-4"></div>

      <!-- Resultat-summering -->
      <div class="rounded-2xl border shadow-sm p-3 mb-4 bg-white">
        <div class="text-sm text-gray-500">Resultat</div>
        <div class="grid grid-cols-3 gap-2 mt-2 text-center">
          <div class="rounded-xl border p-2"><div class="text-xs text-gray-500">Vinst</div><div id="stat-v" class="text-lg font-semibold">0</div></div>
          <div class="rounded-xl border p-2"><div class="text-xs text-gray-500">Oavgjort</div><div id="stat-o" class="text-lg font-semibold">0</div></div>
          <div class="rounded-xl border p-2"><div class="text-xs text-gray-500">Förlust</div><div id="stat-f" class="text-lg font-semibold">0</div></div>
        </div>
        <div class="text-xs text-gray-500 mt-2">Tot. minuter (alla målvakter): <span id="stat-min" class="font-medium text-gray-700">0</span></div>
      </div>

      <!-- Matcher -->
      <div id="match-list" class="space-y-3 mb-24"></div>
    </div>
  </div>

  <script>
    // ====== Supabase-konfig (BYT VÄRDEN HÄR) ======
    const SUPABASE_URL  = "https://okdvcvbmgposbhvrygop.supabase.co";   // <-- byt
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rZHZjdmJtZ3Bvc2JodnJ5Z29wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2ODgyMjUsImV4cCI6MjA3MzI2NDIyNX0.w4SCljFULEduafWZexzmQqyG08pGoUFOeSCbfuCFaJg";                  // <-- byt
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // ====== Helpers ======
    const $ = (s) => document.querySelector(s);
    const today = () => new Date().toISOString().slice(0, 10);
    const num = (v) => { const n = Number(String(v ?? '').replace(',', '.')); return Number.isFinite(n) ? n : 0; };
    const sum = (a) => a.reduce((x,y)=>x+(Number.isFinite(y)?y:0),0);
    const pct = (saves, shots) => shots>0 ? ((saves/shots)*100).toFixed(2)+'%' : '–';

    function showError(where, err) {
      console.error(where, err);
      const msg = (err && (err.message || err.details || err.hint)) || String(err);
      const box = $('#app-msg') || $('#auth-msg');
      if (box) box.textContent = `[${where}] ${msg}`;
    }

    async function getSessionSafe(timeoutMs = 2000) {
      // Race: getSession vs timeout
      const timeout = new Promise((_, rej) => setTimeout(() => rej(new Error('getSession timeout')), timeoutMs));
      try {
        const res = await Promise.race([sb.auth.getSession(), timeout]);
        if (res?.data?.session) return res.data.session;
      } catch {}
      // Fallback – tvinga nätverkskoll
      const userRes = await sb.auth.getUser();
      if (userRes?.data?.user) {
        const s = await sb.auth.getSession();
        return s?.data?.session ?? null;
      }
      return null;
    }

    // ====== Auth UI ======
    const authBox = $('#auth');
    const appBox  = $('#app');
    const authForms = $('#auth-forms');
    const authMsg = $('#auth-msg');
    const whoami  = $('#whoami');
    const btnSignOut = $('#btn-signout');

    $('#btn-signup').addEventListener('click', async () => {
      authMsg.textContent = '';
      try {
        const { error } = await sb.auth.signUp({ email: $('#email').value.trim(), password: $('#password').value });
        if (error) throw error;
        authMsg.textContent = 'Konto skapat. Logga in om du inte redan är inloggad.';
      } catch (e) { showError('signup', e); }
    });

    $('#btn-signin').addEventListener('click', async () => {
      authMsg.textContent = '';
      try {
        const { error } = await sb.auth.signInWithPassword({ email: $('#email').value.trim(), password: $('#password').value });
        if (error) throw error;
      } catch (e) { showError('signin', e); }
    });

    btnSignOut.addEventListener('click', async () => {
      await sb.auth.signOut();
    });

    let CURRENT_UID = null;

    async function boot() {
      try {
        const session = await getSessionSafe();
        if (session?.user?.id) {
          CURRENT_UID = session.user.id;
          whoami.textContent = `Inloggad som ${session.user.email}`;
          whoami.classList.remove('hidden');
          btnSignOut.classList.remove('hidden');
          authForms.classList.add('hidden');
          appBox.classList.remove('hidden');
          await initApp();
        } else {
          CURRENT_UID = null;
          whoami.classList.add('hidden');
          btnSignOut.classList.add('hidden');
          authForms.classList.remove('hidden');
          appBox.classList.add('hidden');
        }
      } catch (e) { showError('boot', e); }
    }

    sb.auth.onAuthStateChange((_ev, session) => {
      CURRENT_UID = session?.user?.id || null;
      boot();
    });
    boot(); // första uppstarten vid sidladdning

    // ====== DB-funktioner (ALLTID med user_id) ======
    async function dbEnsureDefaultGoalies() {
      const { data, error } = await sb.from('goalies').select('id').limit(1);
      if (error) throw error;
      if (!data || data.length === 0) {
        const { error: insErr } = await sb.from('goalies').insert([
          { user_id: CURRENT_UID, code:'LL', name:'Leo L' },
          { user_id: CURRENT_UID, code:'IE', name:'Isac E' },
          { user_id: CURRENT_UID, code:'EH', name:'Emil H' },
          { user_id: CURRENT_UID, code:'LK', name:'Leo K' },
        ]);
        if (insErr) throw insErr;
      }
    }

    async function dbLoadGoalies() {
      const { data, error } = await sb.from('goalies').select('id, code, name').order('code');
      if (error) throw error;
      return data;
    }

    async function dbAddGoalie(code, name) {
      const { data, error } = await sb
        .from('goalies')
        .insert([{ user_id: CURRENT_UID, code, name }])
        .select('id')
        .single();
      if (error) throw error;
      return data.id;
    }

    async function dbAddMatch({ date, opponent, result, notes, entries }) {
      const { data: mData, error: mErr } = await sb
        .from('matches')
        .insert([{ user_id: CURRENT_UID, date, opponent, result, notes }])
        .select('id')
        .single();
      if (mErr) throw mErr;
      const matchId = mData.id;

      const { data: gData, error: gErr } = await sb.from('goalies').select('id, code');
      if (gErr) throw gErr;
      const idByCode = Object.fromEntries(gData.map(g => [g.code, g.id]));

      const rows = entries.map(e => ({
        user_id:  CURRENT_UID,
        match_id: matchId,
        goalie_id: idByCode[e.code],
        minutes:  e.minutes|0,
        saves:    e.saves|0,
        shots:    e.shots|0,
      }));
      const { error: sErr } = await sb.from('match_goalie_stats').insert(rows);
      if (sErr) throw sErr;
      return matchId;
    }

    async function dbListMatches() {
      const { data, error } = await sb
        .from('matches')
        .select(`
          id, date, opponent, result, notes,
          match_goalie_stats (
            minutes, saves, shots, goalie_id,
            goalies:goalie_id ( code, name )
          )
        `)
        .order('date', { ascending: false });
      if (error) throw error;

      return data.map(m => ({
        id: m.id,
        date: m.date,
        opponent: m.opponent,
        result: m.result,
        notes: m.notes,
        entries: (m.match_goalie_stats || []).map(e => ({
          code: e.goalies.code,
          name: e.goalies.name,
          minutes: e.minutes,
          saves: e.saves,
          shots: e.shots
        }))
      }));
    }

    async function dbDeleteMatch(matchId) {
      const { error } = await sb.from('matches').delete().eq('id', matchId);
      if (error) throw error;
    }

    // ====== App state & UI ======
    let GOALIES = []; // [{id, code, name}]
    let formResult = 'V';

    async function initApp() {
      $('#f-date').value = today();

      // resultatknappar
      document.querySelectorAll('.resbtn').forEach(btn => {
        btn.classList.remove('border-black');
        if (btn.dataset.res === 'V') btn.classList.add('border-black');
        btn.onclick = () => {
          formResult = btn.dataset.res;
          document.querySelectorAll('.resbtn').forEach(b => b.classList.remove('border-black'));
          btn.classList.add('border-black');
        };
      });

      try {
        if (!CURRENT_UID) throw new Error('Inte inloggad.');
        await dbEnsureDefaultGoalies();
        GOALIES = await dbLoadGoalies();
        renderGoalieInputs();
        await refreshAll();
      } catch (e) { showError('initApp', e); }

      $('#reset-entries').onclick = () => {
        GOALIES.forEach(g => {
          $('#m-'+g.code).value='0';
          $('#s-'+g.code).value='0';
          $('#t-'+g.code).value='0';
        });
      };

      $('#btn-add-goalie').onclick = async () => {
        const code = prompt('Kod (t.ex. LL):')?.trim();
        const name = prompt('Namn (t.ex. Leo L):')?.trim();
        if (!code || !name) return;
        try {
          await dbAddGoalie(code, name);
          GOALIES = await dbLoadGoalies();
          renderGoalieInputs();
        } catch (e) { showError('add-goalie', e); }
      };

      $('#add-match').onclick = async () => {
        $('#app-msg').textContent = '';
        const entries = GOALIES.map(g => ({
          code: g.code,
          minutes: num($('#m-'+g.code).value),
          saves:   num($('#s-'+g.code).value),
          shots:   num($('#t-'+g.code).value),
        }));
        try {
          if (!CURRENT_UID) throw new Error('Inte inloggad.');
          await dbAddMatch({
            date: $('#f-date').value || today(),
            opponent: $('#f-opp').value || '',
            result: formResult,
            notes: '',
            entries
          });
          document.querySelectorAll('#goalie-grid input').forEach(i => i.value = '0');
          $('#f-opp').value = '';
          await refreshAll();
        } catch (e) { showError('add-match', e); }
      };
    }

    function renderGoalieInputs(){
      const grid = $('#goalie-grid');
      grid.innerHTML = '';
      GOALIES.forEach(g => {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-12 items-center gap-2';
        row.innerHTML = `
          <div class="col-span-4">
            <div class="font-medium text-sm">${g.name}</div>
            <div class="text-xs text-gray-500">${g.code}</div>
          </div>
          <input id="m-${g.code}" inputmode="numeric" class="col-span-2 rounded-xl border p-2 text-center" placeholder="min" value="0" />
          <input id="s-${g.code}" inputmode="numeric" class="col-span-3 rounded-xl border p-2 text-center" placeholder="räddn" value="0" />
          <input id="t-${g.code}" inputmode="numeric" class="col-span-3 rounded-xl border p-2 text-center" placeholder="skott" value="0" />
        `;
        grid.appendChild(row);
      });
    }

    async function refreshAll(){
      try {
        const matches = await dbListMatches();
        renderCards(matches);
        renderResultSummary(matches);
        renderMatchList(matches);
      } catch (e) { showError('refresh-all', e); }
    }

    function renderCards(matches){
      const wrap = $('#cards'); wrap.innerHTML = '';
      GOALIES.forEach(g => {
        const all = matches.flatMap(m => m.entries.filter(e => e.code === g.code));
        const minutes = sum(all.map(e => e.minutes));
        const saves   = sum(all.map(e => e.saves));
        const shots   = sum(all.map(e => e.shots));
        const card = document.createElement('div');
        card.className = 'rounded-2xl border shadow-sm p-3 bg-white';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-gray-500">Målvakt</div>
              <div class="text-lg font-semibold">${g.name} <span class="text-sm text-gray-500">(${g.code})</span></div>
            </div>
            <div class="text-right">
              <div class="text-sm text-gray-500">Rädd%</div>
              <div class="text-xl font-bold">${pct(saves, shots)}</div>
            </div>
          </div>
          <div class="grid grid-cols-3 gap-2 mt-3 text-center text-sm">
            <div class="rounded-xl border p-2"><div class="text-xs text-gray-500">Minuter</div><div class="font-semibold">${minutes}</div></div>
            <div class="rounded-xl border p-2"><div class="text-xs text-gray-500">Räddningar</div><div class="font-semibold">${saves}</div></div>
            <div class="rounded-xl border p-2"><div class="text-xs text-gray-500">Skott</div><div class="font-semibold">${shots}</div></div>
          </div>
        `;
        wrap.appendChild(card);
      });
    }

    function renderResultSummary(matches){
      const v = matches.filter(m => m.result === 'V').length;
      const o = matches.filter(m => m.result === 'O').length;
      const f = matches.filter(m => m.result === 'F').length;
      $('#stat-v').textContent = v;
      $('#stat-o').textContent = o;
      $('#stat-f').textContent = f;
      const minutesTotal = GOALIES
        .map(g => matches.flatMap(m => m.entries.filter(e => e.code === g.code)).reduce((a,e)=>a+e.minutes,0))
        .reduce((a,b)=>a+b,0);
      $('#stat-min').textContent = minutesTotal;
    }

    function renderMatchList(matches){
      const list = $('#match-list'); list.innerHTML = '';
      if (!matches.length) {
        const empty = document.createElement('div');
        empty.className='text-center text-sm text-gray-500';
        empty.textContent='Inga matcher ännu. Lägg till första ovan.';
        list.appendChild(empty);
        return;
      }
      matches.forEach(m => {
        const box = document.createElement('div');
        box.className='rounded-2xl border shadow-sm bg-white';
        const header = document.createElement('div');
        header.className='flex items-center justify-between p-3';
        header.innerHTML = `
          <div>
            <div class="text-sm font-semibold">${m.opponent || 'Motstånd saknas'}</div>
            <div class="text-xs text-gray-500">${m.date} • ${m.result==='V'?'Vinst':m.result==='O'?'Oavgjort':'Förlust'}</div>
          </div>
          <button class="text-xs underline">Ta bort</button>
        `;
        header.querySelector('button').addEventListener('click', async ()=>{
          try { await dbDeleteMatch(m.id); await refreshAll(); } catch(e){ showError('delete-match', e); }
        });

        const body = document.createElement('div');
        body.className='border-t p-3';
        const head = document.createElement('div');
        head.className='grid grid-cols-12 text-xs font-medium text-gray-500';
        head.innerHTML='<div class="col-span-4">Målvakt</div><div class="col-span-2 text-center">Min</div><div class="col-span-3 text-center">Räddn</div><div class="col-span-3 text-center">Skott</div>';
        body.appendChild(head);

        m.entries.forEach(e=>{
          if ((e.minutes||0)+(e.saves||0)+(e.shots||0)===0) return;
          const row = document.createElement('div');
          row.className='grid grid-cols-12 items-center py-1';
          row.innerHTML = `<div class="col-span-4 text-sm">${e.name} <span class="text-gray-500">(${e.code})</span></div>
                           <div class="col-span-2 text-center">${e.minutes}</div>
                           <div class="col-span-3 text-center">${e.saves}</div>
                           <div class="col-span-3 text-center">${e.shots}</div>`;
          body.appendChild(row);
        });

        box.appendChild(header); box.appendChild(body);
        list.appendChild(box);
      });
    }
  </script>
</body>
</html>
