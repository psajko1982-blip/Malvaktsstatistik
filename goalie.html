<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MV - M�lvaktsdetaljer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}</style>
</head>
<body class="bg-gray-50">
  <div class="mx-auto max-w-screen-md p-3 sm:p-4">
    <!-- Header -->
    <div class="sticky top-0 z-10 -mx-3 -mt-3 mb-3 bg-white/80 backdrop-blur p-3 border-b">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-xl font-bold">MV - M�lvaktsdetaljer</h1>
          <p class="text-sm text-gray-600">Per match, grafer & export</p>
        </div>
        <a href="index.html" class="text-sm underline">? Tillbaka</a>
      </div>
    </div>

    <!-- Summering -->
    <div id="head" class="rounded-2xl border bg-white p-4 shadow-sm mb-4">
      <div class="flex flex-wrap items-center justify-between gap-2">
        <div>
          <div class="text-sm text-gray-500">M�lvakt</div>
          <div id="g-name" class="text-xl font-semibold">-</div>
          <div id="g-meta" class="text-xs text-gray-500">-</div>
        </div>
        <div class="text-right">
          <div class="text-sm text-gray-500">R�dd%</div>
          <div id="g-svpct" class="text-2xl font-bold">-</div>
        </div>
      </div>
      <div class="grid sm:grid-cols-3 gap-2 mt-3 text-center">
        <div class="rounded-xl border p-2"><div class="text-xs text-gray-500">Minuter</div><div id="g-min" class="font-semibold">0</div></div>
        <div class="rounded-xl border p-2"><div class="text-xs text-gray-500">R�ddningar</div><div id="g-saves" class="font-semibold">0</div></div>
        <div class="rounded-xl border p-2"><div class="text-xs text-gray-500">Skott</div><div id="g-shots" class="font-semibold">0</div></div>
      </div>
    </div>

    <!-- Grafer -->
    <div class="grid gap-4 mb-4">
      <div class="rounded-2xl border shadow-sm p-3 bg-white">
        <div class="text-sm text-gray-500">R�dd% �ver tid (3-matchers snitt)</div>
        <div class="mt-3 h-48"><canvas id="svpctChart"></canvas></div>
        <div id="chart-empty" class="text-center text-sm text-gray-500 mt-2 hidden">Ingen data att visa �nnu.</div>
      </div>
      <div class="rounded-2xl border shadow-sm p-3 bg-white">
        <div class="text-sm text-gray-500">Skott & R�ddningar per match</div>
        <div class="mt-3 h-48"><canvas id="srChart"></canvas></div>
      </div>
    </div>

    <!-- Tabell & export -->
    <div class="rounded-2xl border shadow-sm p-3 bg-white">
      <div class="flex items-center justify-between">
        <div class="text-sm text-gray-500">Matcher</div>
        <button id="btn-exp-csv" class="rounded-xl border px-3 py-1 text-sm">Exportera CSV</button>
      </div>
      <div class="overflow-x-auto mt-2">
        <table class="w-full text-sm">
          <thead class="text-left text-gray-500">
            <tr>
              <th class="py-2 pr-2">Datum</th>
              <th class="py-2 pr-2">Motst�nd</th>
              <th class="py-2 pr-2 text-right">Min</th>
              <th class="py-2 pr-2 text-right">R�ddn</th>
              <th class="py-2 pr-2 text-right">Skott</th>
              <th class="py-2 pr-2 text-right">R�dd%</th>
            </tr>
          </thead>
          <tbody id="tbl" class="divide-y"></tbody>
        </table>
      </div>
    </div>

    <div id="msg" class="text-sm text-red-600 mt-3"></div>
  </div>

<script>
/* ========= URL-parametrar ========= */
const qs = new URLSearchParams(location.search);
const TEAM_ID = qs.get('team') || '';
const CODE    = (qs.get('code') || '').toUpperCase();

/* ========= Supabase - samma som index.html ========= */
const SUPABASE_URL  = "https://okdvcvbmgposbhvrygop.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rZHZjdmJtZ3Bvc2JodnJ5Z29wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2ODgyMjUsImV4cCI6MjA3MzI2NDIyNX0.w4SCljFULEduafWZexzmQqyG08pGoUFOeSCbfuCFaJg";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true, storage: window.localStorage }
});

/* ========= Hj�lpare ========= */
const $ = s => document.querySelector(s);
const pctText = (saves, shots) => shots>0 ? ((saves/shots)*100).toFixed(2)+'%' : '-';
const pctNum  = (saves, shots) => shots>0 ? +(((saves/shots)*100).toFixed(2)) : null;
const escCSV  = v => { const s=String(v??''); return /[;"\n]/.test(s)?'"'+s.replaceAll('"','""')+'"':s; };
function download(filename, content, mime){ const b=new Blob([content],{type:(mime||'text/plain')+';charset=utf-8'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=filename; a.click(); URL.revokeObjectURL(u); }

/* ========= Session ========= */
async function ensureSession(timeoutMs=4000){
  let { data:{ session } } = await sb.auth.getSession();
  if (session) return session;
  return await new Promise(resolve => {
    const timer = setTimeout(async () => resolve((await sb.auth.getSession()).data.session || null), timeoutMs);
    const { data: sub } = sb.auth.onAuthStateChange((_evt, s) => { if (s) { clearTimeout(timer); sub.subscription.unsubscribe(); resolve(s); } });
  });
}

/* ========= Grafer ========= */
let svpctChart=null, srChart=null;
function movingAvg(arr, window=3){
  const out=[]; for(let i=0;i<arr.length;i++){ const s=arr.slice(Math.max(0,i-window+1),i+1).filter(v=>v!=null);
    out.push(s.length?+(s.reduce((a,b)=>a+b,0)/s.length).toFixed(2):null); } return out;
}
function renderCharts(rows){
  const labels = rows.map(r=>r.date);
  const sv = rows.map(r=>pctNum(r.saves, r.shots));
  const ma = movingAvg(sv, 3);
  const empty = $('#chart-empty');
  empty.classList.toggle('hidden', sv.some(v=>v!=null));

  if(svpctChart) svpctChart.destroy();
  if (sv.some(v=>v!=null)){
    svpctChart = new Chart($('#svpctChart').getContext('2d'), {
      type:'line',
      data:{ labels, datasets:[
        { label:'R�dd%', data: sv, spanGaps:true, tension:0.3, pointRadius:3 },
        { label:'3-matchers snitt', data: ma, spanGaps:true, borderDash:[6,4], tension:0.3, pointRadius:0 }
      ]},
      options:{
        responsive:true, maintainAspectRatio:false,
        scales:{ y:{ suggestedMin:60, suggestedMax:100, ticks:{ callback:v=>v+'%' }}, x:{ ticks:{ autoSkip:true, maxRotation:0 } } },
        plugins:{ legend:{ position:'bottom' } }
      }
    });
  }

  if(srChart) srChart.destroy();
  if (rows.length){
    srChart = new Chart($('#srChart').getContext('2d'), {
      type:'bar',
      data:{ labels, datasets:[
        { label:'Skott', data: rows.map(r=>r.shots) },
        { label:'R�ddningar', data: rows.map(r=>r.saves) }
      ]},
      options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } }, plugins:{ legend:{ position:'bottom' } } }
    });
  }
}

/* ========= Tabell & export ========= */
function renderTable(rows){
  const tbody = $('#tbl'); tbody.innerHTML='';
  if(!rows.length){ tbody.innerHTML = `<tr><td colspan="6" class="py-3 text-center text-gray-500">Inga matcher �nnu.</td></tr>`; return; }
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="py-2 pr-2">${r.date}</td>
      <td class="py-2 pr-2">${r.opponent||''}</td>
      <td class="py-2 pr-2 text-right">${r.minutes}</td>
      <td class="py-2 pr-2 text-right">${r.saves}</td>
      <td class="py-2 pr-2 text-right">${r.shots}</td>
      <td class="py-2 pr-2 text-right">${pctText(r.saves, r.shots)}</td>
    `;
    tbody.appendChild(tr);
  });
}
function exportRowsCSV(goalie, rows){
  const head = ['date','opponent','minutes','saves','shots','save_pct'];
  const lines = [head.join(';')];
  rows.forEach(r=>{
    const p = r.shots>0?((r.saves/r.shots)*100).toFixed(2):'';
    lines.push([`"${r.date}"`, escCSV(r.opponent||''), r.minutes, r.saves, r.shots, p].join(';'));
  });
  const BOM = '\uFEFF'; download(`mv_${goalie.code}_matches.csv`, BOM+lines.join('\r\n'), 'text/csv');
}

/* ========= Laddning ========= */
async function loadPage(){
  if(!TEAM_ID || !CODE){ $('#msg').textContent='Saknar team eller kod i URL.'; return; }

  try{
    // M�lvakt
    const g = await sb.from('goalies')
      .select('id,name,code')
      .eq('team_id', TEAM_ID).eq('code', CODE)
      .maybeSingle();
    if (g.error) throw g.error;
    if (!g.data){ $('#msg').textContent = `M�lvakt ${CODE} finns inte i detta team.`; return; }

    $('#g-name').textContent = `${g.data.name} (${g.data.code})`;
    $('#g-meta').textContent = `Team: ${TEAM_ID.slice(0,8)}.`;

    // Stats
    const st = await sb.from('match_goalie_stats')
      .select('match_id, minutes, saves, shots')
      .eq('team_id', TEAM_ID)
      .eq('goalie_id', g.data.id);
    if (st.error) throw st.error;

    const matchIds = [...new Set((st.data||[]).map(r=>r.match_id))];
    if (!matchIds.length){
      renderTable([]); renderCharts([]);
      $('#g-min').textContent=0; $('#g-saves').textContent=0; $('#g-shots').textContent=0; $('#g-svpct').textContent='-';
      $('#btn-exp-csv').onclick = ()=>exportRowsCSV(g.data, []);
      return;
    }

    // Matcher
    const m = await sb.from('matches')
      .select('id, date, opponent')
      .in('id', matchIds)
      .order('date', { ascending:true });
    if (m.error) throw m.error;

    // Sammanfoga
    const statById = Object.fromEntries((st.data||[]).map(x => [x.match_id, x]));
    const rows = (m.data||[]).map(mm => {
      const e = statById[mm.id] || { minutes:0, saves:0, shots:0 };
      return { date:mm.date, opponent:mm.opponent, minutes:e.minutes|0, saves:e.saves|0, shots:e.shots|0 };
    }).sort((a,b)=>a.date.localeCompare(b.date));

    // Summera + render
    const minutes = rows.reduce((a,r)=>a+r.minutes,0);
    const saves   = rows.reduce((a,r)=>a+r.saves,0);
    const shots   = rows.reduce((a,r)=>a+r.shots,0);
    $('#g-min').textContent = minutes;
    $('#g-saves').textContent = saves;
    $('#g-shots').textContent = shots;
    $('#g-svpct').textContent = pctText(saves, shots);

    renderTable(rows);
    renderCharts(rows);
    $('#btn-exp-csv').onclick = ()=>exportRowsCSV(g.data, rows);

  } catch(e){
    console.error('[goalie] error', e);
    $('#msg').textContent = e?.message || String(e);
  }
}

/* ========= Boot ========= */
(async () => {
  const s = await ensureSession();
  if (!s) {
    $('#msg').classList.remove('text-red-600');
    $('#msg').classList.add('text-gray-600');
    $('#msg').innerHTML = `Ingen inloggning hittades p� denna sida.<br>
      G� till <a class="underline" href="index.html">startsidan</a>, logga in och klicka vidare igen.`;
    return;
  }
  loadPage();
})();
</script>
</body>
</html>
